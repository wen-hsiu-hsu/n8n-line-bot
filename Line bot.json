{
  "name": "Line bot",
  "nodes": [
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "update",
        "pageId": {
          "__rl": true,
          "value": "={{ $json.eventPageId }}",
          "mode": "id"
        },
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "é›¶æ‰“|multi_select",
              "multiSelectValue": "={{ $json.updateData }}"
            }
          ]
        },
        "options": {}
      },
      "id": "53e83906-4df5-4258-8706-a6175be93a1e",
      "name": "Update Calendar Guest List",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        45392,
        74336
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const logic = $(\"Registration Logic Processor\").item.json;\nif (logic.error) {\n  return { type: 'text', text: logic.error };\n}\n\nconst participants = logic.finalParticipants || [];\nconst guestParticipants = participants.filter(p => p.type === 'guest');\nconst lines = [];\n\nconst grouped = [];\nguestParticipants.forEach(p => {\n    const baseName = p.name.replace(/æœ‹å‹.*$/, 'æœ‹å‹').replace(/ \\d+$/, '');\n    if (grouped.length > 0 && grouped[grouped.length-1].base === baseName) {\n        grouped[grouped.length-1].count++;\n    } else {\n        grouped.push({ base: baseName, name: p.name, type: p.type, count: 1 });\n    }\n});\n\ngrouped.forEach((g, i) => {\n    if (g.count > 1) {\n        lines.push(`${i+1}. ${g.base} +${g.count}`);\n    } else {\n        lines.push(`${i+1}. ${g.name}`);\n    }\n});\n\nconst remaining = Math.max(0, logic.maxSlots - guestParticipants.length);\nconst text = [\n  `${logic.eventDate}`,\n  `é›¶æ‰“åé¡ ${logic.maxSlots} äºº | $${logic.fee}/äºº`,\n  ...lines,\n  `å‰©é¤˜åé¡ï¼š ${remaining} äºº`,\n  '',\n  `è‹¥è¦å ±åè«‹è¼¸å…¥ @Dobby +1`\n].join('\\n');\n\nreturn { type: 'text', text };"
      },
      "id": "821e9b58-6369-41a5-b649-8e459e44fea4",
      "name": "Registration Final Reply",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        45616,
        74056
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "update",
        "pageId": {
          "__rl": true,
          "value": "={{ $json.eventPageId }}",
          "mode": "id"
        },
        "simple": false,
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "è«‹å‡äºº|relation",
              "relationValue": [
                "={{(() => {\nreturn $json.updateData.map(item => item.id).join(',')\n})()}}"
              ]
            }
          ]
        },
        "options": {}
      },
      "id": "7557c02d-99f3-4899-a7a5-3c438adcf1fe",
      "name": "Update Notion Leave",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        45392,
        73680
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "leave-update-id",
                    "leftValue": "={{ $json.updateType }}",
                    "rightValue": "leave",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Update Leave"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "guest-update-id",
                    "leftValue": "={{ $json.updateType }}",
                    "rightValue": "guest",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Update Guest"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "error-update-id",
                    "leftValue": "={{ $json.error }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "notEmpty"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Registration Error"
            }
          ]
        },
        "options": {}
      },
      "id": "8d136f8d-c92a-492d-81d8-deab4f68a2ce",
      "name": "Update Notion Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        45168,
        74040
      ]
    },
    {
      "parameters": {
        "jsCode": "const aggregate = $(\"Aggregate Target\").item.json;\nconst quarterInfo = $(\"å–å¾—è©²å­£è³‡è¨Š\").first().json;\nconst metadata = $(\"metadata\").first().json;\nconst allEvents = $(\"å–å¾—æ‰“çƒæ—¥\").all().map(item => item.json);\nconst peopleList = $(\"Get People Next\").all().map(item => item.json);\n\n// Robust property getters\nconst getDate = (item) => (item.properties?.['æ™‚é–“']?.date?.start || (typeof item.property_æ™‚é–“ === 'string' ? item.property_æ™‚é–“ : item.property_æ™‚é–“?.start));\nconst getRelationIds = (item, key) => (item.properties?.[key]?.relation?.map(r => r.id) || item[`property_${key.toLowerCase()}`] || []);\nconst getMultiSelect = (item, key) => (item.properties?.[key]?.multi_select?.map(s => s.name) || item[`property_${key.toLowerCase()}`] || []);\nconst getNumber = (item, key) => (item.properties?.[key]?.number || item[`property_${key.toLowerCase()}`] || 0);\nconst getName = (item) => (item.properties?.['Name']?.title?.[0]?.plain_text || item.property_name || item.name);\n\nconst targetDate = metadata.nextSaturdayDateText;\nconst eventPage = allEvents.find(page => {\n  const startTime = getDate(page);\n  return startTime && startTime.startsWith(targetDate);\n});\n\nif (!eventPage) {\n  throw new Error(`æ‰¾ä¸åˆ° ${targetDate} çš„æ´»å‹•é é¢`);\n}\n\nconst peopleMap = new Map();\npeopleList.forEach(p => peopleMap.set(p.id, p));\n\nconst command = aggregate.command;\nconst targetPersonId = aggregate.targetPersonId;\nconst targetPersonName = aggregate.targetPersonName;\nconst actorIsAdmin = aggregate.actorIsAdmin;\n\nconst seasonMembers = getRelationIds(quarterInfo, 'å ±åäºº');\nconst isSelfSeasonPlayer = targetPersonId && seasonMembers.includes(targetPersonId);\n\nconst maxCourts = getNumber(eventPage, 'å ´åœ°æ•¸') || getNumber(quarterInfo, 'å ´åœ°æ•¸') || 0;\nconst totalCapacity = maxCourts * 7;\nconst guestCapacity = Math.max(0, totalCapacity - seasonMembers.length);\n\nconst leaveList = getRelationIds(eventPage, 'è«‹å‡äºº');\nconst guestList = getMultiSelect(eventPage, 'é›¶æ‰“'); // Changed to Multi-select (strings)\nconst seasonTotal = seasonMembers.length;\nconst currentAttendance = seasonTotal - leaveList.length + guestList.length;\n\nlet updateType = null;\nlet updateData = null;\nlet error = null;\n\n// Helper to resolve display name (e.g., ä¿®_Kevin -> è¨±æ–‡ä¿®)\nconst resolveDisplayName = (rawBaseName) => {\n    if (rawBaseName === targetPersonName && targetPersonId) {\n        return getName(peopleMap.get(targetPersonId) || {}) || rawBaseName;\n    }\n    return rawBaseName;\n};\n\ntry {\n  if (command === 'å‡' || command === 'éŠ·å‡') {\n    if (!isSelfSeasonPlayer) {\n      error = 'åªæœ‰å­£æ‰“çƒå“¡æ‰èƒ½è«‹å‡/éŠ·å‡å–”';\n    } else {\n      updateType = 'leave';\n      if (command === 'å‡') {\n        if (leaveList.includes(targetPersonId)) {\n          error = `${targetPersonName} å·²ç¶“è«‹éå‡å›‰`;\n        } else {\n          updateData = [...leaveList.map(id => ({ id })), { id: targetPersonId }];\n        }\n      } else {\n        if (!leaveList.includes(targetPersonId)) {\n          error = `${targetPersonName} æœ¬ä¾†å°±æ²’æœ‰è«‹å‡å–”`;\n        } else {\n          updateData = leaveList.filter(id => id !== targetPersonId).map(id => ({ id }));\n        }\n      }\n    }\n  } else if (command === '+1' || command === '+2' || command === '-1') {\n    updateType = 'guest';\n    const count = (command === '+2') ? 2 : 1;\n    \n    // Base name for internal tracking vs display matching\n    let baseName = targetPersonName;\n    if (isSelfSeasonPlayer) baseName = `${targetPersonName}æœ‹å‹`;\n    \n    // Display name based on Personnel List registration\n    const baseDisplayName = resolveDisplayName(baseName);\n\n    if (command.startsWith('+')) {\n      if (currentAttendance + count > totalCapacity && !actorIsAdmin) {\n        error = 'åé¡å·²æ»¿å›‰ï¼Œä¸‹æ¬¡è«‹æ—©é»å–Šè²ï¼';\n      } else {\n        const newGuests = [...guestList];\n        for (let i = 0; i < count; i++) {\n           let attempt = 1;\n           while (true) {\n             const candidate = attempt === 1 ? baseDisplayName : `${baseDisplayName} ${attempt}`;\n             if (!newGuests.includes(candidate)) {\n               newGuests.push(candidate);\n               break;\n             }\n             attempt++;\n           }\n        }\n        updateData = newGuests; // Array of strings for Multi-select\n      }\n    } else {\n      const matchedIndices = guestList.map((name, index) => ({ name, index }))\n        .filter(g => g.name === baseDisplayName || g.name.startsWith(`${baseDisplayName} `));\n      \n      if (matchedIndices.length === 0) {\n        error = `æ‰¾ä¸åˆ° ${targetPersonName} çš„å ±åç´€éŒ„`;\n      } else {\n        // Sort to remove the highest numbered one (e.g., remove 'è¨±æ–‡ä¿® 2' before 'è¨±æ–‡ä¿®')\n        matchedIndices.sort((a, b) => {\n            const getNum = (s) => {\n                if (s === baseDisplayName) return 1;\n                const m = s.match(/\\d+$/);\n                return m ? parseInt(m[0]) : 1;\n            };\n            return getNum(b.name) - getNum(a.name);\n        });\n        updateData = guestList.filter((_, i) => i !== matchedIndices[0].index);\n      }\n    }\n  }\n} catch (e) {\n  error = 'æˆ‘è…¦è¢‹å£å»ï¼Œçªç„¶ä¸çŸ¥é“è™•ç†é€™äº›äº‹æƒ…äº†...';\n}\n\n// Calculate final participants for reply (preserving seasonal/guest distinction)\nconst finalParticipants = [];\nseasonMembers.forEach(id => {\n  if (!leaveList.includes(id)) {\n    finalParticipants.push({\n      name: getName(peopleMap.get(id) || {}) || \"æœªçŸ¥çƒå“¡\",\n      type: 'season'\n    });\n  }\n});\n\n// Use updated guest list from updateData if successful, otherwise current list\nconst currentGuestList = (updateType === 'guest' && !error) ? updateData : guestList;\ncurrentGuestList.forEach(name => {\n  finalParticipants.push({\n    name: name || \"æœªçŸ¥æœ‹å‹\",\n    type: 'guest'\n  });\n});\n\nreturn {\n  parser: aggregate,\n  eventPageId: eventPage.id,\n  eventDate: targetDate,\n  maxSlots: guestCapacity,\n  fee: getNumber(quarterInfo, 'é›¶æ‰“è²»ç”¨'),\n  updateType,\n  updateData,\n  error,\n  isSeasonPlayer: isSelfSeasonPlayer,\n  finalParticipants\n};"
      },
      "id": "3b96428a-2b88-4651-bf57-d8d63ee05730",
      "name": "Registration Logic Processor",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        44944,
        74056
      ]
    },
    {
      "parameters": {},
      "id": "715fefe2-68e1-4461-919d-a7782a38178d",
      "name": "Sync Registration",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        44720,
        74056
      ]
    },
    {
      "parameters": {},
      "id": "59b66260-a55a-489f-bbce-79b00a4e057b",
      "name": "Sync Notion Data",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        44496,
        74584
      ]
    },
    {
      "parameters": {
        "jsCode": "const parser = $(\"Registration Parser\").item.json;\nconst resolve = $input.item.json;\n\n// Robust property getters\nconst getRegisteredNameId = (item) => (item.properties?.['Registered name']?.relation?.[0]?.id || item.property_registered_name?.[0]);\nconst getCustomName = (item) => (item.properties?.['Custom Name']?.rich_text?.[0]?.plain_text || item.property_custom_name);\nconst getUserId = (item) => (item.properties?.['user_id']?.title?.[0]?.plain_text || item.property_user_id);\nconst getName = (item) => (item.properties?.['Name']?.title?.[0]?.plain_text || item.property_name || item.name);\n\nlet targetPersonId = null;\nlet targetPersonName = \"Unknown\";\n\ntry {\n  if (resolve.type === 'self') {\n    targetPersonId = resolve.targetPersonId;\n    targetPersonName = resolve.targetName;\n  } else if (resolve.type === 'mention') {\n    const targetUser = $(\"Get Target User (Mention)\").item.json;\n    targetPersonId = getRegisteredNameId(targetUser);\n    targetPersonName = getCustomName(targetUser) || getUserId(targetUser);\n  } else {\n    const targetPerson = $(\"Get Target Person (By Name)\").item.json;\n    targetPersonId = targetPerson.id;\n    targetPersonName = getName(targetPerson) || parser.targetName;\n  }\n} catch (e) {\n  // If lookup failed, we still have the name from parser if provided\n  targetPersonName = parser.targetName || \"Unknown\";\n}\n\nreturn {\n  ...parser,\n  actorIsAdmin: resolve.isAdmin,\n  targetPersonId,\n  targetPersonName\n};"
      },
      "id": "3e8b74aa-81af-4c45-92d9-f843dbc01a08",
      "name": "Aggregate Target",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        44496,
        73928
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "252f388d-4ac7-49a4-82ae-a7f18044f701",
          "mode": "list",
          "cachedResultName": "People List"
        },
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "Name",
              "condition": "equals",
              "titleValue": "={{ $json.targetName }}"
            }
          ]
        },
        "options": {}
      },
      "id": "71344c05-46e4-4a5d-a8aa-090239cd6cc9",
      "name": "Get Target Person (By Name)",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        44272,
        73952
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "2e44dbf2-e21c-80d1-af81-c3b61579b3bb",
          "mode": "list",
          "cachedResultName": "USERS"
        },
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "user_id",
              "condition": "equals",
              "titleValue": "={{ $json.targetUserId }}"
            }
          ]
        },
        "options": {}
      },
      "id": "f69f0db6-4184-40c9-a7a3-13170c348018",
      "name": "Get Target User (Mention)",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        44272,
        74144
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "self-id",
                    "leftValue": "={{ $json.branch }}",
                    "rightValue": 0,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Self"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "mention-id",
                    "leftValue": "={{ $json.branch }}",
                    "rightValue": 1,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Mention"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "name-id",
                    "leftValue": "={{ $json.branch }}",
                    "rightValue": 2,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Name"
            }
          ]
        },
        "options": {}
      },
      "id": "5c2668d7-c03d-4aaf-877d-2c23f64bff54",
      "name": "Registration Target Switch",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        44048,
        73984
      ]
    },
    {
      "parameters": {
        "jsCode": "const parser = $(\"Registration Parser\").item.json;\nconst actor = $input.item.json;\n\n// Robust property getters\nconst getRegisteredNameId = (item) => (item.properties?.['Registered name']?.relation?.[0]?.id || item.property_registered_name?.[0]);\nconst getCustomName = (item) => (item.properties?.['Custom Name']?.rich_text?.[0]?.plain_text || item.property_custom_name);\nconst getUserId = (item) => (item.properties?.['user_id']?.title?.[0]?.plain_text || item.property_user_id);\nconst getIsAdmin = (item) => (item.properties?.['is_admin']?.checkbox ?? item.property_is_admin ?? false);\n\nif (parser.isSelf) {\n  return [\n    {\n      json: {\n        type: 'self',\n        targetPersonId: getRegisteredNameId(actor),\n        targetName: getCustomName(actor) || getUserId(actor),\n        isAdmin: getIsAdmin(actor) === true,\n        branch: 0\n      }\n    }\n  ];\n}\n\nif (parser.targetUserId) {\n  return [\n    {\n      json: {\n        type: 'mention',\n        targetUserId: parser.targetUserId,\n        isAdmin: getIsAdmin(actor) === true,\n        branch: 1\n      }\n    }\n  ];\n}\n\nreturn [\n  {\n    json: {\n      type: 'name',\n      targetName: parser.targetName,\n      isAdmin: getIsAdmin(actor) === true,\n      branch: 2\n    }\n  }\n];"
      },
      "id": "68db6784-47d5-4df2-9b79-5c6d17b07c0e",
      "name": "Resolve Registration Target",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        43824,
        74000
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "2e44dbf2-e21c-80d1-af81-c3b61579b3bb",
          "mode": "list",
          "cachedResultName": "USERS"
        },
        "simple": false,
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "user_id|title",
              "condition": "equals",
              "titleValue": "={{ $json.actorUserId }}"
            }
          ]
        },
        "options": {}
      },
      "id": "eaebdf09-af62-486c-83dd-c31d455c6a52",
      "name": "Get Actor User",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        43600,
        74000
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const event = $(\"active\").item.json;\nconst msg = event.message;\nconst text = msg.text.replace(/@Dobby/i, \"\").trim();\n\nconst commandRegex = /(\\+1|\\+2|-1|å‡|éŠ·å‡)/;\nconst match = text.match(commandRegex);\nconst command = match ? match[1] : null;\n\nlet targetName = null;\nlet targetUserId = null;\n\nif (command) {\n  const rawTarget = text.replace(commandRegex, \"\").trim();\n  if (rawTarget) {\n    if (rawTarget.startsWith(\"@\")) {\n      const mentions = msg.mention?.mentions || [];\n      const cleanTarget = rawTarget.substring(1);\n      if (mentions.length > 0) {\n        targetUserId = mentions[0].userId;\n        targetName = cleanTarget;\n      } else {\n        targetName = cleanTarget;\n      }\n    } else {\n      targetName = rawTarget;\n    }\n  }\n}\n\nreturn {\n  command,\n  targetName,\n  targetUserId,\n  originalText: msg.text,\n  isSelf: !targetName && !targetUserId,\n  actorUserId: event.source.userId\n};"
      },
      "id": "9a751202-85fa-4502-80da-f1ec6712448d",
      "name": "Registration Parser",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        43376,
        74216
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "-CIVmb7fG9yIL8IhBGbEG",
          "mode": "list",
          "cachedResultUrl": "/workflow/-CIVmb7fG9yIL8IhBGbEG",
          "cachedResultName": "Notion Badminton update user display_name"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "group_id": "={{ $('Check User Source').item.json.source.groupId }}",
            "user_id": "={{ $('Check User Source').item.json.source.userId }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "group_id",
              "displayName": "group_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        43376,
        72576
      ],
      "id": "ac6dacd0-940a-41f7-ba99-d602a8e15008",
      "name": "Call 'Notion Badminton update user display_name'"
    },
    {
      "parameters": {},
      "id": "3e22f0a3-e4f8-418b-9f48-8cbb3e07694e",
      "name": "Manual Trigger (Push Test)",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        41136,
        72304
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "auto-reply-admin-check",
              "leftValue": "={{ $json._is_admin }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            },
            {
              "id": "webhook-test-url-check",
              "leftValue": "={{ $('Webhook').item.json.webhookUrl }}",
              "rightValue": "webhook-test",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "4ede5797-3dc2-4eee-9a65-f1f7e37d9775",
      "name": "Skip Auto Reply If Admin",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        45168,
        75120
      ]
    },
    {
      "parameters": {
        "jsCode": "// Get original event\nconst originalEvent = $(\"is command\").item.json;\n\n// Get user query results from Notion\nconst users = $input.all();\nconst hasValidUser = users.length > 0 && users[0].json && users[0].json.id;\n\nlet isAdmin = false;\nif (hasValidUser) {\n  const user = users[0].json;\n  // Robust property getter\n  isAdmin = (user.properties?.['is_admin']?.checkbox ?? user.property_is_admin ?? false);\n}\n\n// Return event with admin flag as array\nreturn [{\n  json: {\n    ...originalEvent,\n    _is_admin: isAdmin\n  }\n}];"
      },
      "id": "0dedcf41-2a7e-40eb-a280-ebf90e1ab15b",
      "name": "Extract Admin For Auto Reply",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        44944,
        75120
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "2e44dbf2-e21c-80d1-af81-c3b61579b3bb",
          "mode": "list",
          "cachedResultName": "USERS",
          "cachedResultUrl": "https://www.notion.so/2e44dbf2e21c80d1af81c3b61579b3bb"
        },
        "returnAll": true,
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "user_id|title",
              "condition": "equals",
              "titleValue": "={{ $('is command').item.json.source.userId }}"
            }
          ]
        },
        "options": {}
      },
      "id": "c60b7db3-72a0-4940-a475-b84ca535cabd",
      "name": "Check Admin Before Auto Reply",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        44720,
        75120
      ],
      "alwaysOutputData": true,
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Get original event from 'is command'\nconst originalEvent = $(\"is command\").item.json;\n\n// Get user query results from Notion\nconst users = $input.all();\nconst hasValidUser = users.length > 0 && users[0].json && users[0].json.id;\n\nlet isAdmin = false;\nif (hasValidUser) {\n  const user = users[0].json;\n  // Robust property getter\n  isAdmin = (user.properties?.['is_admin']?.checkbox ?? user.property_is_admin ?? false);\n}\n\n// Merge admin status into event and return as array\nreturn [{\n  json: {\n    ...originalEvent,\n    _is_admin: isAdmin\n  }\n}];"
      },
      "id": "3437abc8-7a7f-466c-ad1d-138d5ae9a882",
      "name": "Merge Admin Into Event",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        42704,
        74136
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "2e44dbf2-e21c-80d1-af81-c3b61579b3bb",
          "mode": "list",
          "cachedResultName": "USERS",
          "cachedResultUrl": "https://www.notion.so/2e44dbf2e21c80d1af81c3b61579b3bb"
        },
        "returnAll": true,
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "user_id|title",
              "condition": "equals",
              "titleValue": "={{ $('is command').item.json.source.userId }}"
            }
          ]
        },
        "options": {}
      },
      "id": "ccad24ae-3f6c-4338-8a68-28c1b483e358",
      "name": "å–å¾—ä½¿ç”¨è€…è¡¨ (lazy)",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        42480,
        74136
      ],
      "alwaysOutputData": true,
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "prod-env-marker",
              "name": "environment",
              "value": "production",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "aef81089-e7c5-472a-ad33-9f1a2d77e26d",
      "name": "Set Environment (Production)",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        41360,
        72112
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "test-env-marker",
              "name": "environment",
              "value": "test",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "abad40f7-dbb2-4313-abf6-9c2783f59d1b",
      "name": "Set Environment (Test)",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        41360,
        72304
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.line.me/v2/bot/message/push",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { \"to\": \"C9fb61df21d9118e77d6e3065716fc08a\", \"messages\": $json.messages } }}",
        "options": {}
      },
      "id": "b21c219e-c095-4d78-a693-8901ad50bf5f",
      "name": "push Dobby",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        43376,
        72304
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "AXXATrQhz9xpUGTR",
          "name": "Line Dobby"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.line.me/v2/bot/message/push",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { \"to\": \"U2a0a2c5054c4fa12b78a1d059411e39c\", \"messages\": $json.messages } }}",
        "options": {}
      },
      "id": "66a1242a-9b77-489f-b314-92cc5b274af1",
      "name": "push çƒä¾†å°±æ‰“ (lab)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        43376,
        72112
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "EeeK58MFzM1kWVEe",
          "name": "Line çƒä¾†å°±æ‰“"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "push-env-check",
              "leftValue": "={{ $json.environment }}",
              "rightValue": "test",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "0c8fee84-004b-4b39-85ae-fef05d6326af",
      "name": "åˆ¤æ–· Push ç’°å¢ƒ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        43152,
        72208
      ]
    },
    {
      "parameters": {},
      "id": "a2ad3b80-832d-4335-8528-9a5605af2743",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        41584,
        72208
      ]
    },
    {
      "parameters": {
        "jsCode": "const messages = $input.all().map(item => item.json)\n\n// å¾ metadata (Push) ç²å– environment\nconst metadataNode = $(\"metadata (Push)\").first();\nconst environment = metadataNode?.json?.environment || \"production\";\n\nreturn {\n  messages,\n  environment\n}"
      },
      "id": "9b3bbe3b-de62-40da-854e-72db4a82a16c",
      "name": "çµ„èµ·ä¾† (Push)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        42928,
        72208
      ]
    },
    {
      "parameters": {
        "jsCode": "const quarterInfo = $('å–å¾—è©²å­£è³‡è¨Š (Push)').first().json;\nconst metadata = $('metadata (Push)').first().json;\n\n// Robust property getters\nconst getNumber = (item, key) => (item.properties?.[key]?.number || item[`property_${key.toLowerCase()}`] || 0);\nconst getFormulaNumber = (item, key) => (item.properties?.[key]?.formula?.number || item[`property_${key.toLowerCase()}`] || 0);\nconst getName = (item) => (item.properties?.['Name']?.title?.[0]?.plain_text || item.property_name || item.name);\nconst getDate = (item) => (item.properties?.['æ™‚é–“']?.date?.start || (typeof item.property_æ™‚é–“ === 'string' ? item.property_æ™‚é–“ : item.property_æ™‚é–“?.start));\n\n// å¾ä¸åŒä¾†æºå½™æ•´è³‡è¨Š\nconst quarterData = {\n  fee: getNumber(quarterInfo, 'é›¶æ‰“è²»ç”¨') || metadata.price,\n  memberCount: getFormulaNumber(quarterInfo, 'å ±åäººæ•¸') || 0,\n  defaultCourts: metadata.courts // Fallback to metadata if not in Quarter DB\n};\n\n// å–å¾—ç•¶å‰ç¯€é» (Event) çš„è³‡æ–™\nconst targetDate = metadata.nextSaturdayDateText;\nconst allEvents = $('å–å¾—æ‰“çƒæ—¥ (Push)').all().map(item => item.json);\n\nconst eventPage = allEvents.find(page => {\n  const startTime = getDate(page);\n  return startTime && startTime.startsWith(targetDate);\n});\n\nif (!eventPage) {\n  return [\n    {\n      \"type\": \"text\",\n      \"text\": `âš ï¸ æ‰¾ä¸åˆ° ${targetDate} çš„æ‰“çƒæ—¥æ´»å‹•ã€‚\\nè«‹ç¢ºèª Notion è¡Œäº‹æ›†æ˜¯å¦å·²å»ºç«‹è©²æ—¥æœŸçš„é é¢ã€‚`\n    }\n  ];\n}\n\n// Get People Map\nconst peopleData = $('Get People Next (Push)').all().map(item => item.json);\nconst peopleMap = new Map();\npeopleData.forEach(p => peopleMap.set(p.id, p));\n\nconst eventData = {\n  type: eventPage.properties?.['é¡å‹']?.select?.name || eventPage.property_é¡å‹,\n  timeStart: getDate(eventPage),\n  courtOverride: getNumber(eventPage, 'å ´åœ°æ•¸'),\n  absenteesRelations: eventPage.properties?.['è«‹å‡äºº']?.relation || eventPage.property_è«‹å‡äºº || [],\n  absenteesCount: (eventPage.properties?.['è«‹å‡äºº']?.relation?.length ?? eventPage.property_è«‹å‡äºº?.length ?? 0)\n};\n\n// 1. æª¢æŸ¥æ˜¯å¦æš«åœ\nif (eventData.type && eventData.type.includes('æš«åœ')) {\n  return [\n    {\n      \"type\": \"text\",\n      \"text\": `ğŸ“… ${targetDate}\\n\\nğŸ›‘ æœ¬é€±æ‰“çƒæš«åœ (Suspended)\\nä¼‘æ¯æ˜¯ç‚ºäº†èµ°æ›´é•·é çš„è·¯ï¼`\n    }\n  ];\n}\n\n// 2. è¨ˆç®—é‚è¼¯\n// å ´åœ°æ•¸ï¼šå„ªå…ˆä½¿ç”¨ Event Overrideï¼Œå¦å‰‡ä½¿ç”¨ Quarter Default (or Metadata default)\nconst finalCourts = eventData.courtOverride || quarterData.defaultCourts;\nconst courtsDensity = 7; // æ¯é¢å ´åœ° 7 äºº\n\n// ç¸½è«‹å‡äººæ•¸ï¼šEvent ç´€éŒ„çš„è«‹å‡äºº + æŒ‡ä»¤åƒæ•¸é¡å¤–æ‰£é™¤çš„ (metadata.offCounts)\nconst manualOffCounts = Number(metadata.offCounts) || 0;\nconst totalAbsentees = eventData.absenteesCount + manualOffCounts;\n\n// Resolve Names\nconst absenteeNames = eventData.absenteesRelations.map(r => {\n    const id = r.id || r;\n    const person = peopleMap.get(id);\n    return getName(person || {});\n}).filter(n => n);\n\nconst leaveString = absenteeNames.length > 0 ? `è«‹å‡ï¼š${absenteeNames.join(', ')}` : `è«‹å‡ï¼šç„¡`;\n\n// æ‡‰åˆ°äººæ•¸ (å­£ç§Ÿ - è«‹å‡)\nconst expectedMembers = quarterData.memberCount - totalAbsentees;\n\n// é›¶æ‰“åé¡\nconst totalSlots = finalCourts * courtsDensity;\nconst availableSlots = Math.max(0, totalSlots - expectedMembers);\n\n// 3. æ ¼å¼åŒ–è¼¸å‡º\nconst dateStr = eventData.timeStart ? eventData.timeStart.split('T')[0] : targetDate;\n\nfunction generateNumberedListString(number) {\n  if (number <= 0) return '(ç„¡åé¡)';\n  const lines = [];\n  for (let i = 1; i <= number; i++) {\n    lines.push(`${i}.`);\n  }\n  return lines.join('\\n');\n}\n\nreturn [\n  {\n    \"type\":\"text\",\n    \"text\":[\n      `${dateStr} ä¸èƒ½åˆ°è«‹å–Šè²`,\n      leaveString,\n      `å ´åœ°ï¼š${finalCourts} é¢`,\n      `æ‡‰åˆ°ï¼š${expectedMembers} äºº`,\n      `é›¶æ‰“åé¡ï¼š${availableSlots}äºº $${quarterData.fee}/äºº`\n    ].join('\\n')\n  },\n  {\n    \"type\":\"text\",\n    \"text\":[\n      `${dateStr}`,\n      `é›¶æ‰“åé¡ ${availableSlots} äºº | $${quarterData.fee}/äºº`, \n      `${generateNumberedListString(availableSlots)}`\n    ].join('\\n')\n  }\n];"
      },
      "id": "ee7052e5-ba68-4aeb-906f-7e921f7fc4bd",
      "name": "ä¸‹æ¬¡æ‰“çƒ v2 (Push)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        42704,
        72208
      ]
    },
    {
      "parameters": {},
      "id": "0ccfa3e0-ef1f-4f21-ab2c-6d0c775cdd9a",
      "name": "Merge (Push)",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        42480,
        72208
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "252f388d-4ac7-49a4-82ae-a7f18044f701",
          "mode": "list",
          "cachedResultName": "äººå“¡æ¸…å–®",
          "cachedResultUrl": "https://www.notion.so/252f388d4ac749a482aea7f18044f701"
        },
        "simple": false,
        "filterType": "json",
        "filterJson": "{}",
        "options": {}
      },
      "id": "c7722600-d0c9-4a01-9ae1-8c538fac936c",
      "name": "Get People Next (Push)",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        42256,
        72112
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "0fd76b77-9f07-4aa3-a3c9-12ba18dbe32e",
          "mode": "list",
          "cachedResultName": "è¡Œäº‹æ›†",
          "cachedResultUrl": "https://www.notion.so/0fd76b779f074aa3a3c912ba18dbe32e"
        },
        "simple": false,
        "filterType": "json",
        "filterJson": "={{ JSON.stringify({ and: [{ property: 'æ™‚é–“', date: { equals: $json.nextSaturdayDateText } }] }) }}",
        "options": {}
      },
      "id": "8bc1765f-f89b-4873-87d3-82b6d0acc4d1",
      "name": "å–å¾—æ‰“çƒæ—¥ (Push)",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        42256,
        72304
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "7deede34-579d-4c77-b79b-20b9f4f000e7",
          "mode": "list",
          "cachedResultName": "å­£ç§Ÿæ‰¿ç§Ÿç´€éŒ„",
          "cachedResultUrl": "https://www.notion.so/7deede34579d4c77b79b20b9f4f000e7"
        },
        "simple": false,
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "å­£ç§Ÿæ™‚æ®µ|title",
              "condition": "equals",
              "titleValue": "={{ $json.nextSaturdayQuarter }}"
            }
          ]
        },
        "options": {}
      },
      "id": "7b1d191d-182b-499d-86b1-7f1c96272c62",
      "name": "å–å¾—è©²å­£è³‡è¨Š (Push)",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        42032,
        72112
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "function getNextSaturday () {\n  const now = DateTime.now();\n  const currentWeekday = now.weekday;\n  const daysUntilSaturday = ((6 - currentWeekday + 7) % 7) || 7;\n  const nextSaturday = now.plus({ days: daysUntilSaturday });\n  return nextSaturday\n}\n\nfunction getNextSaturdayQuarter() {\n  const nextSaturday = getNextSaturday()\n  const year = nextSaturday.year;\n  const quarter = nextSaturday.quarter;\n  return `${year}-Q${quarter}`;\n}\n\nfunction getNextSaturdayDateText () {\n  const nextSaturday = getNextSaturday()\n  return nextSaturday.toFormat('yyyy-MM-dd')\n}\n\nconst DEFAULT_OFF_COUNTS = 0\nconst DEFAULT_COURT = 2\nconst DEFAULT_PRICE = 170\n\n// å¾ä¸Šæ¸¸ç²å– environment\nconst environment = $json.environment || \"production\";\n\nreturn {\n  nextSaturdayQuarter: getNextSaturdayQuarter(),\n  nextSaturdayDateText: getNextSaturdayDateText(),\n  offCounts: DEFAULT_OFF_COUNTS,\n  courts: DEFAULT_COURT,\n  price: DEFAULT_PRICE,\n  environment: environment\n}"
      },
      "id": "d2ea4218-8870-40ea-9567-254922f831cc",
      "name": "metadata (Push)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        41808,
        72208
      ]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "weeks",
              "triggerAtHour": 21
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        41136,
        72112
      ],
      "id": "5646def7-0bcd-4050-b546-e4438601f55e",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {},
      "id": "d170c4f3-5e86-41f3-a036-a3a259bbabef",
      "name": "Merge User Management",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        43152,
        72576
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "update",
        "pageId": {
          "__rl": true,
          "value": "={{ $json.notionPageId }}",
          "mode": "id"
        },
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "message_counts|number",
              "numberValue": "={{ \n(() => {\n  if ($('Check User Source').item.json.type === 'message') {\n    return $json.currentMessageCount + 1\n  }\n  else {\n    return $json.currentMessageCount\n  }\n})()\n}}"
            },
            {
              "key": "groups|multi_select",
              "multiSelectValue": "={{ $json.updatedGroups }}"
            },
            {
              "key": "multi-chat|multi_select",
              "multiSelectValue": "={{ $json.updatedMultiChat }}"
            }
          ]
        },
        "options": {}
      },
      "id": "8a71c99d-1c33-48b3-b8e0-92a1e2e6aa20",
      "name": "æ›´æ–°ä½¿ç”¨è€…",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        42928,
        72536
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// æº–å‚™æ›´æ–°è³‡æ–™\nconst data = $json;\nconst currentGroups = data.currentGroups || [];\nconst currentMultiChat = data.currentMultiChat || [];\nconst groupId = data.currentGroupId;\nconst roomId = data.currentRoomId;\n\n// åˆ†åˆ¥è™•ç† groups å’Œ multi-chatï¼ˆå»é‡ï¼‰\nlet updatedGroups = [...currentGroups];\nlet updatedMultiChat = [...currentMultiChat];\n\n// å¦‚æœä¾†è‡ªç¾¤çµ„ï¼Œæ›´æ–° groups\nif (groupId && !updatedGroups.includes(groupId)) {\n  updatedGroups.push(groupId);\n}\n\n// å¦‚æœä¾†è‡ªèŠå¤©å®¤ï¼Œæ›´æ–° multi-chat\nif (roomId && !updatedMultiChat.includes(roomId)) {\n  updatedMultiChat.push(roomId);\n}\n\nreturn {\n  ...data,\n  updatedGroups: updatedGroups,\n  updatedMultiChat: updatedMultiChat\n};"
      },
      "id": "2d14eb44-8a24-4c5f-b7e9-da3c8fca4526",
      "name": "Prepare Update Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        42704,
        72536
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "user-exists-check",
              "leftValue": "={{ $json.userExists }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "ea366717-8e52-487b-abfb-e8b1fc9b4bee",
      "name": "User Exists Switch",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        42480,
        72576
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const users = $('å–å¾—ä½¿ç”¨è€…è¡¨').all();\nconst source = $('Check User Source').item.json.source;\nconst sourceUserId = source.userId;\n\n// åˆ†åˆ¥å–å¾— groupId å’Œ roomId\nconst currentGroupId = source.groupId || null;\nconst currentRoomId = source.roomId || null;\n\n// æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ä½¿ç”¨è€…è³‡æ–™\nconst hasValidUser = users.length > 0 && users[0].json && users[0].json.id;\n\nif (!hasValidUser) {\n  return {\n    userExists: false,\n    userId: sourceUserId,\n    currentGroupId: currentGroupId,\n    currentRoomId: currentRoomId\n  };\n}\n\n// ä½¿ç”¨è€…å­˜åœ¨ï¼Œè¿”å›ä½¿ç”¨è€…è³‡æ–™\nconst user = users[0].json;\n\n// Robust property getters\nconst getNumber = (item, key) => (item.properties?.[key]?.number || item[`property_${key.toLowerCase()}`] || 0);\nconst getMultiSelect = (item, key) => (item.properties?.[key]?.multi_select?.map(s => s.name) || item[`property_${key.toLowerCase()}`] || []);\n\nreturn {\n  userExists: true,\n  userId: sourceUserId,\n  notionPageId: user.id,\n  currentMessageCount: getNumber(user, 'message_counts'),\n  currentGroups: getMultiSelect(user, 'groups'),\n  currentMultiChat: getMultiSelect(user, 'multi-chat'),\n  currentGroupId: currentGroupId,\n  currentRoomId: currentRoomId\n};"
      },
      "id": "a272c337-7793-4ad7-84c0-0f4a0c9bbb57",
      "name": "Check User Exists",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        42256,
        72576
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-user-source-id",
              "leftValue": "={{ $json.source.userId }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "33413a45-1a5e-4c29-b138-5e6c8119a98c",
      "name": "Check User Source",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        41808,
        73944
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "databaseId": {
          "__rl": true,
          "value": "2e44dbf2-e21c-80d1-af81-c3b61579b3bb",
          "mode": "list",
          "cachedResultName": "USERS",
          "cachedResultUrl": "https://www.notion.so/2e44dbf2e21c80d1af81c3b61579b3bb"
        },
        "propertiesUi": {
          "propertyValues": [
            {
              "key": "user_id|title",
              "title": "={{ $json.userId }}"
            },
            {
              "key": "is_admin|checkbox"
            },
            {
              "key": "message_counts|number",
              "numberValue": "={{ \n(() => {\n  if ($('Check User Source').item.json.type === 'message') {\n    return 1\n  }\n  else {\n    return 0\n  }\n})()\n}}"
            },
            {
              "key": "Custom Name|rich_text"
            },
            {
              "key": "multi-chat|multi_select",
              "multiSelectValue": "={{ $json.currentRoomId ? [$json.currentRoomId] : [] }}"
            },
            {
              "key": "groups|multi_select",
              "multiSelectValue": "={{ $json.currentGroupId ? [$json.currentGroupId] : [] }}"
            }
          ]
        },
        "options": {}
      },
      "id": "820435a1-d27c-4d08-8339-995ed97be4c4",
      "name": "æ–°å¢ä½¿ç”¨è€…",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        42928,
        72728
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "2e44dbf2-e21c-80d1-af81-c3b61579b3bb",
          "mode": "list",
          "cachedResultName": "USERS",
          "cachedResultUrl": "https://www.notion.so/2e44dbf2e21c80d1af81c3b61579b3bb"
        },
        "returnAll": true,
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "user_id|title",
              "condition": "equals",
              "titleValue": "={{ $('Check User Source').item.json.source.userId }}"
            }
          ]
        },
        "options": {}
      },
      "id": "624f351f-365f-4691-85f6-52ffff7b631d",
      "name": "å–å¾—ä½¿ç”¨è€…è¡¨",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        42032,
        72576
      ],
      "alwaysOutputData": true,
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const blocks = $('æ­¡è¿è¨Šæ¯ child blocks').all().map(item => item.json);\nconst webhookData = $('Webhook').first().json;\nconst joinedUserId = webhookData.body.events[0].joined.members[0].userId;\nconst managerId = \"U2a0a2c5054c4fa12b78a1d059411e39c\";\n\nconst validBlocks = blocks.filter(b => b.content && b.content.trim() !== \"\");\nlet templateText = validBlocks.map(b => {\n    if (b.type === 'bulleted_list_item') {\n        return `â€¢ ${b.content}`;\n    }\n    return b.content;\n}).join('\\n');\n\nif (!templateText) templateText = \"æ­¡è¿ï¼ (Welcome Message Empty)\";\n\n// å»ºç«‹ substitution ç‰©ä»¶ï¼ˆä½¿ç”¨ textV2 æ ¼å¼ï¼‰\nconst substitution = {};\n\nif (templateText.includes('{NEW_FRIEND}')) {\n    substitution.NEW_FRIEND = {\n        type: \"mention\",\n        mentionee: {\n            type: \"user\",\n            userId: joinedUserId\n        }\n    };\n}\n\nif (templateText.includes('{MANAGER}')) {\n    substitution.MANAGER = {\n        type: \"mention\",\n        mentionee: {\n            type: \"user\",\n            userId: managerId\n        }\n    };\n}\n\nconst result = {\n    type: \"textV2\",\n    text: templateText\n};\n\nif (Object.keys(substitution).length > 0) {\n    result.substitution = substitution;\n}\n\nreturn result;"
      },
      "id": "3610c50d-d2d0-4ca2-bb3b-79a3ff5ffa87",
      "name": "Welcome Message Parser",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        45616,
        75312
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "81216503-6239-4467-bc6d-06839d375001",
              "leftValue": "={{ $json.source.type }}",
              "rightValue": "group",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "713f0393-789a-4c2f-bfa4-76b3c6606368",
              "leftValue": "={{ $json.source.type }}",
              "rightValue": "room",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "8bc27a0f-5f6f-400e-9f3f-5c58697a0f8a",
      "name": "Join Source Filter",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        44944,
        75312
      ]
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{ $json.type }}",
        "rules": {
          "rules": [
            {
              "value2": "message"
            },
            {
              "value2": "join",
              "output": 1
            },
            {
              "value2": "memberJoined",
              "output": 1
            }
          ]
        }
      },
      "id": "bfe3f304-1e68-4184-a212-6774d9fc09cb",
      "name": "Event Switch",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [
        42032,
        74272
      ]
    },
    {
      "parameters": {
        "resource": "block",
        "operation": "getAll",
        "blockId": {
          "__rl": true,
          "value": "={{ $json.id }}",
          "mode": "id"
        },
        "returnAll": true,
        "fetchNestedBlocks": true
      },
      "id": "18330230-028c-4e75-81fe-5c2b35cc8f5a",
      "name": "æ­¡è¿è¨Šæ¯ child blocks",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        45392,
        75312
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "2e24dbf2-e21c-80b7-83f6-ef99c1dd9425",
          "mode": "list",
          "cachedResultName": "æ‰€æœ‰å…¬å‘Š",
          "cachedResultUrl": "https://www.notion.so/2e24dbf2e21c80b783f6ef99c1dd9425"
        },
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "Name|title",
              "condition": "equals",
              "titleValue": "WELCOME_MESSAGE"
            }
          ]
        },
        "options": {}
      },
      "id": "0a4f03e4-7ec1-410d-bdcb-2fa2346fab3c",
      "name": "å–å¾—æ­¡è¿è¨Šæ¯",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        45168,
        75312
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "webhook-url-check",
              "leftValue": "={{ $('Webhook').first().json.webhookUrl }}",
              "rightValue": "webhook-test",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "f5175940-9d60-4903-9a3c-ec3d8208f3d1",
      "name": "åˆ¤æ–· webhook url",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        46064,
        74056
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.line.me/v2/bot/message/reply",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "replyToken",
              "value": "={{ $json.replyToken }}"
            },
            {
              "name": "messages",
              "value": "={{ $json.messages }}"
            },
            {
              "name": "notificationDisabled",
              "value": "={{ true }}"
            }
          ]
        },
        "options": {}
      },
      "id": "2306a4e1-9840-4996-9cde-5fe410a28828",
      "name": "reply çƒä¾†å°±æ‰“ (lab)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        46288,
        73960
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "EeeK58MFzM1kWVEe",
          "name": "Line çƒä¾†å°±æ‰“"
        },
        "httpBearerAuth": {
          "id": "uGKHMBQPiLQEmUFP",
          "name": "Line Dobby Bearer Auth"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.line.me/v2/bot/message/reply",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "replyToken",
              "value": "={{ $json.replyToken }}"
            },
            {
              "name": "messages",
              "value": "={{ $json.messages }}"
            },
            {
              "name": "notificationDisabled",
              "value": "={{ true }}"
            }
          ]
        },
        "options": {}
      },
      "id": "b95c7d72-5a72-421f-a090-fa6c34610b15",
      "name": "reply Dobby",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        46288,
        74152
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "AXXATrQhz9xpUGTR",
          "name": "Line Dobby"
        },
        "httpBearerAuth": {
          "id": "uGKHMBQPiLQEmUFP",
          "name": "Line Dobby Bearer Auth"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const userMessage = $('Split Out').first().json.message.text || '';\nconst quoteToken = $('Split Out').first().json.message.quoteToken;\nconst replyItems = $input.all().map(item => item.json);\n\n// Robust property getters\nconst getName = (item) => (item.properties?.['name']?.title?.[0]?.plain_text || item.name || '');\nconst getReply = (item) => (item.properties?.['reply']?.rich_text?.[0]?.plain_text || item.property_reply || '');\n\n// æª¢æŸ¥ä½¿ç”¨è€…è¨Šæ¯æ˜¯å¦åŒ…å«ä»»ä¸€ name\nfor (const item of replyItems) {\n    const name = getName(item);\n    if (name && userMessage.includes(name)) {\n        return {\n            type: 'text',\n            text: getReply(item),\n            quoteToken: quoteToken\n        };\n    }\n}\n\n// å¦‚æœæ²’æœ‰åŒ¹é…ï¼Œä¸è¼¸å‡ºä»»ä½•æ±è¥¿ï¼ˆä¸å›è¦†ï¼‰\nreturn [];"
      },
      "id": "9308e9bf-ee40-4d8f-8717-e4907ddc2d4d",
      "name": "Auto Reply Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        45616,
        75120
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "2e34dbf2-e21c-8047-8ac5-fccfc5c02729",
          "mode": "list",
          "cachedResultName": "TEXT_REPLY",
          "cachedResultUrl": "https://www.notion.so/2e34dbf2e21c80478ac5fccfc5c02729"
        },
        "options": {}
      },
      "id": "01d52f19-8c65-4300-adf0-672385553b6d",
      "name": "å–å¾— auto reply message",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        45392,
        75120
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const blocks = $('ä»˜æ¬¾è³‡è¨Š child blocks').all().map(item => item.json);\nconst quoteToken = $('Split Out').first().json.message.quoteToken;\n\nconst validBlocks = blocks.filter(b => b.content && b.content.trim() !== \"\");\nlet templateText = validBlocks.map(b => {\n    if (b.type === 'bulleted_list_item') {\n        return `â€¢ ${b.content}`;\n    }\n    return b.content;\n}).join('\\n');\n\nif (!templateText) templateText = \"ç›®å‰æ²’æœ‰ä»˜æ¬¾è³‡è¨Š (PAYMENT Empty)\";\n\nreturn {\n    \"type\": \"text\",\n    \"text\": templateText,\n    \"quoteToken\": quoteToken\n};"
      },
      "id": "f4b4c602-eea5-40de-b8aa-b289727936b1",
      "name": "Payment Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        45616,
        73488
      ]
    },
    {
      "parameters": {
        "resource": "block",
        "operation": "getAll",
        "blockId": {
          "__rl": true,
          "value": "={{ $json.id }}",
          "mode": "id"
        },
        "returnAll": true,
        "fetchNestedBlocks": true
      },
      "id": "108d7756-3a98-465c-a9b0-281c7909a567",
      "name": "ä»˜æ¬¾è³‡è¨Š child blocks",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        45392,
        73488
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "2e24dbf2-e21c-80b7-83f6-ef99c1dd9425",
          "mode": "list",
          "cachedResultName": "æ‰€æœ‰å…¬å‘Š",
          "cachedResultUrl": "https://www.notion.so/2e24dbf2e21c80b783f6ef99c1dd9425"
        },
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "Name|title",
              "condition": "equals",
              "titleValue": "PAYMENT"
            }
          ]
        },
        "options": {}
      },
      "id": "b5bddb4a-bb4f-4bc8-aaa7-629b2033cd0e",
      "name": "å–å¾—ä»˜æ¬¾è³‡è¨Š",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        45168,
        73488
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "252f388d-4ac7-49a4-82ae-a7f18044f701",
          "mode": "list",
          "cachedResultName": "äººå“¡æ¸…å–®",
          "cachedResultUrl": "https://www.notion.so/252f388d4ac749a482aea7f18044f701"
        },
        "simple": false,
        "filterType": "json",
        "filterJson": "{}",
        "options": {}
      },
      "id": "eb0c0eef-a18c-4320-a7ca-81039c079e6e",
      "name": "Get People for Announce",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        44720,
        72720
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "0fd76b77-9f07-4aa3-a3c9-12ba18dbe32e",
          "mode": "list",
          "cachedResultName": "è¡Œäº‹æ›†",
          "cachedResultUrl": "https://www.notion.so/0fd76b779f074aa3a3c912ba18dbe32e"
        },
        "returnAll": true,
        "simple": false,
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "å­£åº¦|relation",
              "condition": "contains",
              "relationValue": "={{ $json.id }}"
            }
          ]
        },
        "options": {}
      },
      "id": "921e9422-5bec-4125-a4d5-766e445fbc49",
      "name": "Get Calendar for Announce",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        44720,
        72528
      ],
      "alwaysOutputData": false,
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "7deede34-579d-4c77-b79b-20b9f4f000e7",
          "mode": "list"
        },
        "simple": false,
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "å­£ç§Ÿæ™‚æ®µ|title",
              "condition": "equals",
              "titleValue": "={{ $json.targetQuarter }}"
            }
          ]
        },
        "options": {}
      },
      "id": "9a487eb7-22fd-4f5e-a2d0-730608789313",
      "name": "Get Season Info for Announce",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        44496,
        72528
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "function getNextSaturday () {\n  const now = DateTime.now(); \n  const currentWeekday = now.weekday; \n  const daysUntilSaturday = ((6 - currentWeekday + 7) % 7) || 7; \n  const nextSaturday = now.plus({ days: daysUntilSaturday });\n  return nextSaturday\n}\n\nfunction getNextSaturdayQuarter() {\n  const nextSaturday = getNextSaturday()\n  const year = nextSaturday.year;\n  const quarter = nextSaturday.quarter; \n  return `${year}-Q${quarter}`; \n}\n\nreturn {\n  targetQuarter: getNextSaturdayQuarter()\n}"
      },
      "id": "211e94dd-b601-4bf4-865f-0cefb663a937",
      "name": "Announce Metadata",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        44272,
        72800
      ]
    },
    {
      "parameters": {
        "jsCode": "const blocks = $('æœ€æ–°å…¬å‘Š child blocks').all().map(item => item.json);\nconst seasonPage = $('Get Season Info for Announce').first().json;\nconst calendarPages = $('Get Calendar for Announce').all().map(item => item.json);\nconst peopleList = $('Get People for Announce').all().map(item => item.json);\n\nconst quoteToken = $('Split Out').first().json.message.quoteToken;\n\n// Validate Data\nif (!seasonPage) {\n    return {\n        type: \"text\",\n        text: \"âŒ æ‰¾ä¸åˆ°æœ¬å­£å­£åº¦è³‡æ–™\",\n        quoteToken: quoteToken\n    };\n}\n\n// --- Helper: People Map ---\nconst peopleMap = new Map();\npeopleList.forEach(p => peopleMap.set(p.id, p));\n\nfunction getPersonName(id) {\n    const p = peopleMap.get(id);\n    if (!p) return \"Unknown\";\n    return p.properties['Name']?.title?.[0]?.plain_text || p.name || \"Unknown\";\n}\n\n// --- Prepare Variables ---\n\n// {SEASON}\nconst SEASON = seasonPage.properties['å­£ç§Ÿæ™‚æ®µ']?.title?.[0]?.plain_text || \"Unknown-Quarter\";\n\n// {FROM_TO_MONTH}\nlet FROM_TO_MONTH = \"\";\nif (SEASON.includes(\"Q1\")) FROM_TO_MONTH = \"1~3æœˆ\";\nelse if (SEASON.includes(\"Q2\")) FROM_TO_MONTH = \"4~6æœˆ\";\nelse if (SEASON.includes(\"Q3\")) FROM_TO_MONTH = \"7~9æœˆ\";\nelse if (SEASON.includes(\"Q4\")) FROM_TO_MONTH = \"10~12æœˆ\";\n\n// {TOTAL_PEOPLE}\nconst TOTAL_PEOPLE = seasonPage.properties['å ±åäººæ•¸']?.formula?.number || 0;\n\n// {LIST_ALL_PEOPLE}\nconst relations = seasonPage.properties['å ±åäºº']?.relation || [];\nconst LIST_ALL_PEOPLE = relations.map(r => getPersonName(r.id)).join(\"ã€\");\n\n// {PRICE_PER_PERSON_FOR_SEASON}\nconst PRICE_PER_PERSON_FOR_SEASON = seasonPage.properties['æ¯äººå¹³å‡å ´ç§Ÿ']?.formula?.number || 0;\n\n// {PRICE_PER_PERSON_FOR_ONCE}\nconst PRICE_PER_PERSON_FOR_ONCE = seasonPage.properties['é›¶æ‰“è²»ç”¨']?.number || 0;\n\n// {COURT_COUNT}\nconst COURT_COUNT = seasonPage.properties['å ´åœ°æ•¸']?.number || 0;\n\n// {TOTAL_PRICE}\nconst TOTAL_PRICE = seasonPage.properties['å ´ç§Ÿç¸½é‡‘é¡']?.formula?.number || 0;\n\n// {LOCATION}\nconst LOCATION = seasonPage.properties['åœ°é»']?.rich_text?.[0]?.plain_text || \n               seasonPage.properties['åœ°é»']?.select?.name || \"æœªçŸ¥åœ°é»\";\n\n// Filter active play dates (exclude paused)\nconst activeCalendarPages = calendarPages.filter(p => {\n    const type = p.properties['é¡å‹']?.select?.name;\n    return type !== 'æš«åœ';\n});\n\n// {WEEK_COUNTS}\nconst WEEK_COUNTS = activeCalendarPages.length;\n\n// {LIST_ALL_DATES}\n// Sort by date first\nactiveCalendarPages.sort((a, b) => {\n    const da = a.properties['æ™‚é–“']?.date?.start || \"\";\n    const db = b.properties['æ™‚é–“']?.date?.start || \"\";\n    return da.localeCompare(db);\n});\n\nconst datesByMonth = {};\nactiveCalendarPages.forEach(p => {\n    const dateStr = p.properties['æ™‚é–“']?.date?.start;\n    if (!dateStr) return;\n    const dt = DateTime.fromISO(dateStr);\n    const monthKey = dt.toFormat(\"MM\");\n    const dayStr = dt.toFormat(\"M/dd\");\n    \n    if (!datesByMonth[monthKey]) datesByMonth[monthKey] = [];\n    datesByMonth[monthKey].push(dayStr);\n});\n\nconst LIST_ALL_DATES = Object.keys(datesByMonth).sort().map(m => {\n    return datesByMonth[m].join(\", \");\n}).join(\"\\n\");\n\n\n// --- Construct Template ---\nconst validBlocks = blocks.filter(b => b.content && b.content.trim() !== \"\");\nlet templateText = validBlocks.map(b => {\n    if (b.type === 'bulleted_list_item') {\n        return `â€¢ ${b.content}`;\n    }\n    return b.content;\n}).join('\\n');\n\nif (!templateText) templateText = \"ç›®å‰æ²’æœ‰å…¬å‘Š (NEW_TEMPLATE Empty)\";\n\n// --- Replace Placeholders ---\nlet finalText = templateText;\nfinalText = finalText.replace(/{SEASON}/g, SEASON);\nfinalText = finalText.replace(/{FROM_TO_MONTH}/g, FROM_TO_MONTH);\nfinalText = finalText.replace(/{TOTAL_PEOPLE}/g, TOTAL_PEOPLE);\nfinalText = finalText.replace(/{LIST_ALL_PEOPLE}/g, LIST_ALL_PEOPLE);\nfinalText = finalText.replace(/{PRICE_PER_PERSON_FOR_SEASON}/g, PRICE_PER_PERSON_FOR_SEASON);\nfinalText = finalText.replace(/{WEEK_COUNTS}/g, WEEK_COUNTS);\nfinalText = finalText.replace(/{PRICE_PER_PERSON_FOR_ONCE}/g, PRICE_PER_PERSON_FOR_ONCE);\nfinalText = finalText.replace(/{COURT_COUNT}/g, COURT_COUNT);\nfinalText = finalText.replace(/{TOTAL_PRICE}/g, TOTAL_PRICE);\nfinalText = finalText.replace(/{LIST_ALL_DATES}/g, LIST_ALL_DATES);\nfinalText = finalText.replace(/{LOCATION}/g, LOCATION);\n\nreturn {\n    \"type\": \"text\",\n    \"text\": finalText,\n    \"quoteToken\": quoteToken\n};"
      },
      "name": "Latest Announcement Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        45616,
        72896
      ],
      "id": "39cfc538-c898-4bcf-bc7a-d0b78f9ed0aa"
    },
    {
      "parameters": {
        "resource": "block",
        "operation": "getAll",
        "blockId": {
          "__rl": true,
          "value": "={{ $json.id }}",
          "mode": "id"
        },
        "returnAll": true,
        "fetchNestedBlocks": true
      },
      "id": "3237c268-caf5-450b-b055-1d42ccf92f48",
      "name": "æœ€æ–°å…¬å‘Š child blocks",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        44944,
        72912
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "2e24dbf2-e21c-80b7-83f6-ef99c1dd9425",
          "mode": "list",
          "cachedResultName": "æ‰€æœ‰å…¬å‘Š",
          "cachedResultUrl": "https://www.notion.so/2e24dbf2e21c80b783f6ef99c1dd9425"
        },
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "Name|title",
              "condition": "equals",
              "titleValue": "NEWS_TEMPLATE"
            }
          ]
        },
        "options": {}
      },
      "id": "88dd992a-4397-4bde-a0ce-4f38481149e3",
      "name": "å–å¾—æœ€æ–°å…¬å‘Š",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        44720,
        72912
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {},
      "id": "140c5561-f9d9-4ecd-b253-e6cc3a97bbe7",
      "name": "Merge",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        44496,
        74392
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "display-id",
                    "leftValue": "={{ $('active').item.json.message.text }}",
                    "rightValue": "!next",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Display"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "registration-id",
                    "leftValue": "={{ $('active').item.json.message.text }}",
                    "rightValue": "@Dobby",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Registration"
            }
          ]
        },
        "options": {}
      },
      "id": "77d4cc7a-c5ce-44d4-a092-ba0acb596019",
      "name": "Flow Router (People)",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        44272,
        74632
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "display-id",
                    "leftValue": "={{ $('active').item.json.message.text }}",
                    "rightValue": "!next",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Display"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "registration-id",
                    "leftValue": "={{ $('active').item.json.message.text }}",
                    "rightValue": "@Dobby",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Registration"
            }
          ]
        },
        "options": {}
      },
      "id": "0748700c-7e8b-4209-a291-0ecd477afc48",
      "name": "Flow Router (Next)",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        44272,
        74344
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "252f388d-4ac7-49a4-82ae-a7f18044f701",
          "mode": "list",
          "cachedResultName": "äººå“¡æ¸…å–®",
          "cachedResultUrl": "https://www.notion.so/252f388d4ac749a482aea7f18044f701"
        },
        "simple": false,
        "filterType": "json",
        "filterJson": "{}",
        "options": {}
      },
      "id": "fe5c296f-5696-48d8-8908-5ca8c0bac10c",
      "name": "Get People Next",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        44048,
        74632
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const seasonPage = $('Get Season Info Custom').first().json;\n// Optimize: Create a map for O(1) lookup\nconst peopleMap = new Map();\n$input.all().forEach(item => {\n    peopleMap.set(item.json.id, item.json);\n});\n\nconst quoteToken = $('Split Out').first().json.message.quoteToken;\n\nif (!seasonPage) {\n    return {\n        \"type\": \"text\",\n        \"text\": \"âŒ æ‰¾ä¸åˆ°å­£åº¦è³‡æ–™\",\n        \"quoteToken\": quoteToken\n    };\n}\n\nconst quarterTitle = seasonPage.properties['å­£ç§Ÿæ™‚æ®µ']?.title?.[0]?.plain_text || \"æœªçŸ¥å­£åº¦\";\nconst relations = seasonPage.properties['å ±åäºº']?.relation || [];  \n\nif (relations.length === 0) {\n     return {\n        \"type\": \"text\",\n        \"text\": `ğŸ¸ ${quarterTitle} å°šç„¡å ±åè³‡æ–™`,\n        \"quoteToken\": quoteToken\n    };\n}\n\nconst participantIds = relations.map(r => r.id);\nconst names = [];\n\nfor (const id of participantIds) {\n    const person = peopleMap.get(id); \n    let name = \"Unknown\";\n    if (person) {\n         if (person.properties?.['Name']?.title?.[0]?.plain_text) {\n             name = person.properties['Name'].title[0].plain_text;\n         } else if (person.name) {\n             name = person.name;\n         }\n    }\n    names.push(name);\n}\n\nreturn {\n    \"type\": \"text\",\n    \"text\": `ğŸ¸ ${quarterTitle} å ±ååå–® (${names.length}äºº)ï¼š\\n\\n${names.join('ã€')}`,\n    \"quoteToken\": quoteToken\n};"
      },
      "id": "dae452cb-0267-4fdb-94e5-39c1ffe56bfd",
      "name": "Match Participants",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        45616,
        74832
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "252f388d-4ac7-49a4-82ae-a7f18044f701",
          "mode": "list",
          "cachedResultName": "äººå“¡æ¸…å–®",
          "cachedResultUrl": "https://www.notion.so/252f388d4ac749a482aea7f18044f701"
        },
        "simple": false,
        "filterType": "json",
        "filterJson": "{}",
        "options": {}
      },
      "id": "c928d503-ee00-4a65-b740-a5a6c7d0aab2",
      "name": "Get All People Global",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        45392,
        74832
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "7deede34-579d-4c77-b79b-20b9f4f000e7",
          "mode": "list",
          "cachedResultName": "å­£ç§Ÿæ‰¿ç§Ÿç´€éŒ„",
          "cachedResultUrl": "https://www.notion.so/7deede34579d4c77b79b20b9f4f000e7"
        },
        "simple": false,
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "å­£ç§Ÿæ™‚æ®µ|title",
              "condition": "equals",
              "titleValue": "={{ $json.targetQuarter }}"
            }
          ]
        },
        "options": {}
      },
      "id": "69b7c1c8-7886-494d-962e-98b405962442",
      "name": "Get Season Info Custom",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        45168,
        74832
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "function getQuarter(date) {\n  const year = date.year;\n  const quarter = date.quarter;\n  return `${year}-Q${quarter}`;\n}\n\n// Use $json directly in runOnceForEachItem mode\nconst text = $json.message.text;\nlet arg = text.replace(/^(!participants|!people|ï¼å ±åäºº)\\s*/i, '').trim();\n\nlet targetQuarter;\nif (arg) {\n    targetQuarter = arg.toUpperCase();\n} else {\n    targetQuarter = getQuarter(DateTime.now());\n}\n\nreturn {\n    targetQuarter\n}"
      },
      "id": "01214e50-29fd-452b-8e3d-ccf48c5a356d",
      "name": "Season Metadata",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        44944,
        74832
      ]
    },
    {
      "parameters": {
        "jsCode": "const quarterInfo = $('å–å¾—è©²å­£è³‡è¨Š').first().json;\nconst metadata = $('metadata').first().json;\n\n// Robust property getters\nconst getNumber = (item, key) => (item.properties?.[key]?.number || item[`property_${key.toLowerCase()}`] || 0);\nconst getFormulaNumber = (item, key) => (item.properties?.[key]?.formula?.number || item[`property_${key.toLowerCase()}`] || 0);\nconst getName = (item) => (item.properties?.['Name']?.title?.[0]?.plain_text || item.property_name || item.name);\nconst getDate = (item) => (item.properties?.['æ™‚é–“']?.date?.start || (typeof item.property_æ™‚é–“ === 'string' ? item.property_æ™‚é–“ : item.property_æ™‚é–“?.start));\n\n// å¾ä¸åŒä¾†æºå½™æ•´è³‡è¨Š\nconst quarterData = {\n  fee: getNumber(quarterInfo, 'é›¶æ‰“è²»ç”¨') || metadata.price,\n  memberCount: getFormulaNumber(quarterInfo, 'å ±åäººæ•¸') || 0,\n  defaultCourts: metadata.courts // Fallback to metadata if not in Quarter DB\n};\n\n// å–å¾—ç•¶å‰ç¯€é» (Event) çš„è³‡æ–™\nconst targetDate = metadata.nextSaturdayDateText;\nconst allEvents = $('å–å¾—æ‰“çƒæ—¥').all().map(item => item.json);\n\nconst eventPage = allEvents.find(page => {\n  const startTime = getDate(page);\n  return startTime && startTime.startsWith(targetDate);\n});\n\nif (!eventPage) {\n  return [\n    {\n      \"type\": \"text\",\n      \"text\": `âš ï¸ æ‰¾ä¸åˆ° ${targetDate} çš„æ‰“çƒæ—¥æ´»å‹•ã€‚\\nè«‹ç¢ºèª Notion è¡Œäº‹æ›†æ˜¯å¦å·²å»ºç«‹è©²æ—¥æœŸçš„é é¢ã€‚`\n    }\n  ];\n}\n\n// Get People Map\nconst peopleData = $('Get People Next').all().map(item => item.json);\nconst peopleMap = new Map();\npeopleData.forEach(p => peopleMap.set(p.id, p));\n\nconst eventData = {\n  type: eventPage.properties?.['é¡å‹']?.select?.name || eventPage.property_é¡å‹,\n  timeStart: getDate(eventPage),\n  courtOverride: getNumber(eventPage, 'å ´åœ°æ•¸'),\n  absenteesRelations: eventPage.properties?.['è«‹å‡äºº']?.relation || eventPage.property_è«‹å‡äºº || [],\n  absenteesCount: (eventPage.properties?.['è«‹å‡äºº']?.relation?.length ?? eventPage.property_è«‹å‡äºº?.length ?? 0)\n};\n\n// 1. æª¢æŸ¥æ˜¯å¦æš«åœ\nif (eventData.type && eventData.type.includes('æš«åœ')) {\n  return [\n    {\n      \"type\": \"text\",\n      \"text\": `ğŸ“… ${targetDate}\\n\\nğŸ›‘ æœ¬é€±æ‰“çƒæš«åœ (Suspended)\\nä¼‘æ¯æ˜¯ç‚ºäº†èµ°æ›´é•·é çš„è·¯ï¼`\n    }\n  ];\n}\n\n// 2. è¨ˆç®—é‚è¼¯\n// å ´åœ°æ•¸ï¼šå„ªå…ˆä½¿ç”¨ Event Overrideï¼Œå¦å‰‡ä½¿ç”¨ Quarter Default (or Metadata default)\nconst finalCourts = eventData.courtOverride || quarterData.defaultCourts;\nconst courtsDensity = 7; // æ¯é¢å ´åœ° 7 äºº\n\n// ç¸½è«‹å‡äººæ•¸ï¼šEvent ç´€éŒ„çš„è«‹å‡äºº + æŒ‡ä»¤åƒæ•¸é¡å¤–æ‰£é™¤çš„ (metadata.offCounts)\nconst manualOffCounts = Number(metadata.offCounts) || 0;\nconst totalAbsentees = eventData.absenteesCount + manualOffCounts;\n\n// Resolve Names\nconst absenteeNames = eventData.absenteesRelations.map(r => {\n    const id = r.id || r;\n    const person = peopleMap.get(id);\n    return getName(person || {});\n}).filter(n => n);\n\nconst leaveString = absenteeNames.length > 0 ? `è«‹å‡ï¼š${absenteeNames.join(', ')}` : `è«‹å‡ï¼šç„¡`;\n\n// æ‡‰åˆ°äººæ•¸ (å­£ç§Ÿ - è«‹å‡)\nconst expectedMembers = quarterData.memberCount - totalAbsentees;\n\n// é›¶æ‰“åé¡ (Total Slots - Expected Members)\nconst totalSlots = finalCourts * courtsDensity;\nconst availableSlots = Math.max(0, totalSlots - expectedMembers);\n\n// 3. æ ¼å¼åŒ–è¼¸å‡º\nconst dateStr = eventData.timeStart ? eventData.timeStart.split('T')[0] : targetDate;\n\nfunction generateNumberedListString(number) {\n  if (number <= 0) return '(ç„¡åé¡)';\n  const lines = [];\n  for (let i = 1; i <= number; i++) {\n    lines.push(`${i}.`);\n  }\n  return lines.join('\\n');\n}\n\nreturn [\n  {\n    \"type\":\"text\",\n    \"text\":[\n      `${dateStr} ä¸èƒ½åˆ°è«‹å–Šè²`,\n      leaveString,\n      `å ´åœ°ï¼š${finalCourts} é¢`,\n      `æ‡‰åˆ°ï¼š${expectedMembers} äºº`,\n      `é›¶æ‰“åé¡ï¼š${availableSlots}äºº $${quarterData.fee}/äºº`\n    ].join('\\n')\n  },\n  {\n    \"type\":\"text\",\n    \"text\":[\n      `${dateStr}`,\n      `é›¶æ‰“åé¡ ${availableSlots} äºº | $${quarterData.fee}/äºº`, \n      `${generateNumberedListString(availableSlots)}`\n    ].join('\\n')\n  }\n];"
      },
      "id": "5cbdaf2f-5882-4673-becf-6cc5e2868fa5",
      "name": "ä¸‹æ¬¡æ‰“çƒ v2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        44720,
        74520
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "0fd76b77-9f07-4aa3-a3c9-12ba18dbe32e",
          "mode": "list",
          "cachedResultName": "è¡Œäº‹æ›†",
          "cachedResultUrl": "https://www.notion.so/0fd76b779f074aa3a3c912ba18dbe32e"
        },
        "simple": false,
        "filterType": "json",
        "filterJson": "={{ JSON.stringify({ and: [{ property: 'æ™‚é–“', date: { equals: $json.nextSaturdayDateText } }] }) }}",
        "options": {}
      },
      "id": "537da5b2-c693-496b-a628-3e71e63b2738",
      "name": "å–å¾—æ‰“çƒæ—¥",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        44048,
        74344
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const quoteToken = $('Split Out').all().map(item => item.json.message.quoteToken)[0]\n\nreturn [\n  {\n    \"type\":\"text\",\n    \"text\":[\n      'ğŸ› ï¸ æŒ‡ä»¤åˆ—è¡¨',\n      '----------',\n      'ã€æŸ¥è©¢é¡ã€‘',\n      '{!owe}ã€{ï¼æ¬ }ï¼šæœªç¹³è²»åå–®',\n      '{!command}ã€{ï¼æŒ‡ä»¤}ï¼šæœ¬åˆ—è¡¨',\n      '{!participants}ã€{ï¼å ±åäºº}ï¼šæŸ¥è©¢å­£åº¦å ±åäºº (Alias: !people)',\n      '{!news}ã€{ï¼å…¬å‘Š}ï¼šæŸ¥è©¢æœ€æ–°å…¬å‘Š (Alias: !announcement)',\n      '{!payment}ã€{ï¼ä»˜æ¬¾}ï¼šæŸ¥è©¢ä»˜æ¬¾è³‡è¨Š',\n      '',\n      'ã€å ±å/è«‹å‡é¡ã€‘',\n      '{@Dobby +1}ï¼šå ±åé›¶æ‰“',\n      '{@Dobby +2}ï¼šå ±åå…©ä½',\n      '{@Dobby -1}ï¼šå–æ¶ˆå ±å',\n      '{@Dobby å‡}ï¼šå­£ç§Ÿæˆå“¡è«‹å‡',\n      '{@Dobby éŠ·å‡}ï¼šå­£ç§Ÿæˆå“¡éŠ·å‡',\n      '----------',\n      `âœ¶ è«‹æ³¨æ„ä¸­æ–‡ä½¿ç”¨å…¨å‹`,\n      `âœ¶ æŒ‡ä»¤ä¸åŒ…å« {}`,\n    ].join('\\n'),\n    \"quoteToken\": quoteToken,\n    \"quickReply\": {\n      \"items\": [\n        {\n          \"type\": \"action\",\n          \"action\": {\n            \"type\": \"message\",\n            \"label\": \"æœªç¹³è²»åå–®\",\n            \"text\": \"!owe\"\n          }\n        },\n        {\n          \"type\": \"action\",\n          \"action\": {\n            \"type\": \"message\",\n            \"label\": \"æŒ‡ä»¤åˆ—è¡¨\",\n            \"text\": \"!command\"\n          }\n        },\n        {\n          \"type\": \"action\",\n          \"action\": {\n            \"type\": \"message\",\n            \"label\": \"å­£åº¦å ±åäºº\",\n            \"text\": \"!participants\"\n          }\n        },\n        {\n           \"type\": \"action\",\n           \"action\": {\n             \"type\": \"message\",\n             \"label\": \"æœ€æ–°å…¬å‘Š\",\n             \"text\": \"!news\"\n           }\n        },\n        {\n           \"type\": \"action\",\n           \"action\": {\n             \"type\": \"message\",\n             \"label\": \"ä»˜æ¬¾è³‡è¨Š\",\n             \"text\": \"!payment\"\n           }\n        }\n      ]\n    }\n  }\n]"
      },
      "id": "d89e45ea-8f1c-43dd-981f-e503cc075d77",
      "name": "æŒ‡ä»¤åˆ—è¡¨ message1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        45616,
        73296
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ [\"ï¼æ¬ \", \"!owe\"] }}",
                    "rightValue": "={{ $('active').item.json.message.text }}",
                    "operator": {
                      "type": "array",
                      "operation": "contains",
                      "rightType": "any"
                    },
                    "id": "5262e45f-c423-4422-bbab-a582c41e003b"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "æœªç¹³è²»åå–®"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "59f498ff-7248-4bc5-ae95-c79839c4d9c5",
                    "leftValue": "={{ [\"!command\", \"ï¼æŒ‡ä»¤\"] }}",
                    "rightValue": "={{ $('active').item.json.message.text }}",
                    "operator": {
                      "type": "array",
                      "operation": "contains",
                      "rightType": "any"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "æŒ‡ä»¤åˆ—è¡¨"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "season-rule-id",
                    "leftValue": "={{ [\"!participants\", \"!people\", \"ï¼å ±åäºº\"] }}",
                    "rightValue": "={{ $('active').item.json.message.text }}",
                    "operator": {
                      "type": "array",
                      "operation": "contains",
                      "rightType": "any"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "å­£åº¦å ±åäºº"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "news-rule-id",
                    "leftValue": "={{ [\"!news\", \"!announcement\", \"ï¼å…¬å‘Š\"] }}",
                    "rightValue": "={{ $('active').item.json.message.text }}",
                    "operator": {
                      "type": "array",
                      "operation": "contains",
                      "rightType": "any"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "æœ€æ–°å…¬å‘Š"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "payment-rule-id",
                    "leftValue": "={{ [\"!payment\", \"ï¼ä»˜æ¬¾\"] }}",
                    "rightValue": "={{ $('active').item.json.message.text }}",
                    "operator": {
                      "type": "array",
                      "operation": "contains",
                      "rightType": "any"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ä»˜æ¬¾è³‡è¨Š"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "dobby-registration-id",
                    "leftValue": "={{ $('active').item.json.message.text }}",
                    "rightValue": "@Dobby",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "å ±åè«‹å‡"
            }
          ]
        },
        "options": {}
      },
      "id": "2e77550e-50c8-4457-9a1f-c0365b899c4b",
      "name": "Command controller",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        43152,
        73328
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "32110570-2baa-4dcf-b097-8d42114fa839",
              "leftValue": "={{ $json.message.text }}",
              "rightValue": "!",
              "operator": {
                "type": "string",
                "operation": "startsWith"
              }
            },
            {
              "id": "beae70d8-4b6e-4a35-bc7c-0b6bc404f2fe",
              "leftValue": "={{ $json.message.text }}",
              "rightValue": "ï¼",
              "operator": {
                "type": "string",
                "operation": "startsWith"
              }
            },
            {
              "id": "dobby-prefix-id",
              "leftValue": "={{ $json.message.text }}",
              "rightValue": "@Dobby",
              "operator": {
                "type": "string",
                "operation": "startsWith"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "38ac0886-8c29-4bad-ac32-2117fd6a3c67",
      "name": "is command",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        42256,
        74208
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "function getNextSaturday () {\n  const now = DateTime.now(); \n  const currentWeekday = now.weekday; \n  const daysUntilSaturday = ((6 - currentWeekday + 7) % 7) || 7; \n  const nextSaturday = now.plus({ days: daysUntilSaturday });\n  return nextSaturday\n}\n\nfunction getNextSaturdayQuarter() {\n  const nextSaturday = getNextSaturday()\n  const year = nextSaturday.year;\n  const quarter = nextSaturday.quarter; \n  return `${year}-Q${quarter}`; \n}\n\nfunction getNextSaturdayDateText () {\n  const nextSaturday = getNextSaturday()\n  return nextSaturday.toFormat('yyyy-MM-dd')\n}\n\nreturn {\n  nextSaturdayQuarter: getNextSaturdayQuarter(),\n  nextSaturdayDateText: getNextSaturdayDateText(),\n}"
      },
      "id": "577c1aa3-43b8-49ec-881b-f742beaca74c",
      "name": "metadata1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        45168,
        73104
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "18fbd263-5f9a-42f8-9d26-e4fe973b4135",
                    "leftValue": "={{ $('active').item.json.message.text }}",
                    "rightValue": "!next",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ä¸‹ä¸€æ¬¡çš„é€šçŸ¥"
            }
          ]
        },
        "options": {}
      },
      "id": "3e5fce0a-4a7a-4550-8063-008f2cdc9ff7",
      "name": "Manager rules",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        43376,
        74976
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "dc929aeb-b84a-4007-9838-9c3f91500ff3",
              "leftValue": "={{ $json._is_admin }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "78ef6da1-134f-4a09-96ae-bdf4d80afaa0",
      "name": "if this user is manager",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        42928,
        74136
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "function getNextSaturday () {\n  const now = DateTime.now(); \n  const currentWeekday = now.weekday; \n  const daysUntilSaturday = ((6 - currentWeekday + 7) % 7) || 7; \n  const nextSaturday = now.plus({ days: daysUntilSaturday });\n  return nextSaturday\n}\n\nfunction getNextSaturdayQuarter() {\n  const nextSaturday = getNextSaturday()\n  const year = nextSaturday.year;\n  const quarter = nextSaturday.quarter; \n  return `${year}-Q${quarter}`; \n}\n\nfunction getNextSaturdayDateText () {\n  const nextSaturday = getNextSaturday()\n  return nextSaturday.toFormat('yyyy-MM-dd')\n}\n\nconst event = $json.message ? $json : $(\"active\").item.json;\nconst text = event.message?.text || '';\nconst queryIndex = text.indexOf('?');\nlet params = {};\n\nif (queryIndex !== -1) {\n  const queryString = text.substring(queryIndex + 1);\n  // URLSearchParams handles parsing efficiently\n  const urlParams = new URLSearchParams(queryString);\n  params = Object.fromEntries(urlParams.entries());\n}\n\nconst DEFAULT_OFF_COUNTS = 0\nconst DEFAULT_COURT = 2\nconst DEFAULT_PRICE = 170\n\nreturn {\n  nextSaturdayQuarter: getNextSaturdayQuarter(),\n  nextSaturdayDateText: getNextSaturdayDateText(),\n  offCounts: params['-'] ?? DEFAULT_OFF_COUNTS,\n  courts: params['c'] ?? DEFAULT_COURT,\n  price: DEFAULT_PRICE\n}"
      },
      "id": "2f3224a8-aabc-4ce5-b61d-a47b8c877070",
      "name": "metadata",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        43600,
        74504
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "7deede34-579d-4c77-b79b-20b9f4f000e7",
          "mode": "list",
          "cachedResultName": "å­£ç§Ÿæ‰¿ç§Ÿç´€éŒ„",
          "cachedResultUrl": "https://www.notion.so/7deede34579d4c77b79b20b9f4f000e7"
        },
        "simple": false,
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "å­£ç§Ÿæ™‚æ®µ|title",
              "condition": "equals",
              "titleValue": "={{ $json.nextSaturdayQuarter }}"
            }
          ]
        },
        "options": {}
      },
      "id": "49cf7b0a-dbd9-4fd9-ab90-a175e7366def",
      "name": "å–å¾—è©²å­£è³‡è¨Š",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        43824,
        74632
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const prevNodeName = $prevNode.name\n\nconst messages = $input.all().map(item => item.json)\n\nconst replyToken = $('active').all()[$runIndex].json.replyToken\n\nreturn {\n  messages,\n  replyToken\n}"
      },
      "id": "8ba473bf-91d8-4650-93d5-2bb11bf1feee",
      "name": "çµ„èµ·ä¾†",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        45840,
        74056
      ]
    },
    {
      "parameters": {
        "fieldToSplitOut": "body.events",
        "options": {}
      },
      "id": "48c3111b-f208-426b-9c7c-2f1257ad034a",
      "name": "Split Out",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        41360,
        73944
      ]
    },
    {
      "parameters": {},
      "id": "4ecb6d23-189f-47bb-8a5a-1f32bb660bd1",
      "name": "Merge Branches 2",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        45392,
        72896
      ]
    },
    {
      "parameters": {},
      "id": "b721ca45-34e8-4546-858c-5d86db495bd0",
      "name": "Merge Branches 1",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        45168,
        72704
      ]
    },
    {
      "parameters": {
        "jsCode": "return [{json:{done:true}}];"
      },
      "id": "8668e755-6f04-49fc-9d8f-793aa420346b",
      "name": "End Branch Blocks",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        45168,
        72912
      ]
    },
    {
      "parameters": {
        "jsCode": "return [{json:{done:true}}];"
      },
      "id": "4b4a5c5e-47dd-430f-8e0c-4c2729905f71",
      "name": "End Branch People",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        44944,
        72720
      ]
    },
    {
      "parameters": {
        "jsCode": "return [{json:{done:true}}];"
      },
      "id": "85a4f8d6-57a7-429a-ac56-25985ab805fb",
      "name": "End Branch Calendar",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        44944,
        72528
      ]
    },
    {
      "parameters": {
        "jsCode": "const prevNodeName = $prevNode.name\n\nconst peopleName = $(prevNodeName).all().map(item => item.json.name)\n\nconst quoteToken = $('Split Out').all().map(item => item.json.message.quoteToken)[0]\n\nconst nextSaturdayQuarter = $('metadata1').first().json.nextSaturdayQuarter\n\nreturn [\n  {\n    \"type\":\"text\",\n    \"text\":[\n      `${nextSaturdayQuarter}`, \n      `ğŸ’€ å°šæœªç¹³è²»ï¼š ${peopleName.join(', ')}`,\n      '',\n      `âœ¶ å¦‚æœå·²ç¶“ä»˜éŒ¢å»ä»åœ¨é€™å€‹åå–®ä¸Šï¼Œæ‡‰è©²æ˜¯è¨˜å¸³ç²¾éˆæ‹–å»¶ç—‡ç™¼ä½œ`\n    ].join('\\n'),\n    \"quoteToken\": quoteToken,\n  }\n]"
      },
      "id": "111bcf68-38ff-4d75-b887-a131f0881f2b",
      "name": "æœªç¹³è²» message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        45616,
        73104
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "252f388d-4ac7-49a4-82ae-a7f18044f701",
          "mode": "list",
          "cachedResultName": "äººå“¡æ¸…å–®",
          "cachedResultUrl": "https://www.notion.so/252f388d4ac749a482aea7f18044f701"
        },
        "filterType": "json",
        "filterJson": "={\n  \"property\":\"çµæ¸…\",\n  \"formula\":{\n    \"checkbox\": {\n      \"equals\": false\n    }\n  }\n}",
        "options": {}
      },
      "id": "970301d2-d528-44c2-90d5-46d42ffc97f2",
      "name": "æœªç¹³è²»åå–®",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        45392,
        73104
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "c52d968e-9ddc-4ccd-b4db-98a7f7aedd45",
              "leftValue": "={{ $json.mode }}",
              "rightValue": "active",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "0da1ca7d-e728-4ac5-a7c8-51d5fa204fcb",
      "name": "active",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        41584,
        73944
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "6ffc18b9-7e3e-464a-9572-f35473e52d4d",
        "options": {}
      },
      "id": "095a18e4-197d-4609-9b46-d57541350716",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        41136,
        73944
      ],
      "webhookId": "6ffc18b9-7e3e-464a-9572-f35473e52d4d"
    }
  ],
  "pinData": {},
  "connections": {
    "Update Calendar Guest List": {
      "main": [
        [
          {
            "node": "Registration Final Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Notion Leave": {
      "main": [
        [
          {
            "node": "Registration Final Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Notion Router": {
      "main": [
        [
          {
            "node": "Update Notion Leave",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update Calendar Guest List",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Registration Final Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registration Logic Processor": {
      "main": [
        [
          {
            "node": "Update Notion Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sync Registration": {
      "main": [
        [
          {
            "node": "Registration Logic Processor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sync Notion Data": {
      "main": [
        [
          {
            "node": "Sync Registration",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Aggregate Target": {
      "main": [
        [
          {
            "node": "Sync Registration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Target Person (By Name)": {
      "main": [
        [
          {
            "node": "Aggregate Target",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Target User (Mention)": {
      "main": [
        [
          {
            "node": "Aggregate Target",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registration Target Switch": {
      "main": [
        [
          {
            "node": "Aggregate Target",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Target User (Mention)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Target Person (By Name)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resolve Registration Target": {
      "main": [
        [
          {
            "node": "Registration Target Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Actor User": {
      "main": [
        [
          {
            "node": "Resolve Registration Target",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registration Parser": {
      "main": [
        [
          {
            "node": "Get Actor User",
            "type": "main",
            "index": 0
          },
          {
            "node": "metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Admin For Auto Reply": {
      "main": [
        [
          {
            "node": "Skip Auto Reply If Admin",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Admin Before Auto Reply": {
      "main": [
        [
          {
            "node": "Extract Admin For Auto Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å–å¾—ä½¿ç”¨è€…è¡¨ (lazy)": {
      "main": [
        [
          {
            "node": "Merge Admin Into Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger (Push Test)": {
      "main": [
        [
          {
            "node": "Set Environment (Test)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Environment (Production)": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Environment (Test)": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åˆ¤æ–· Push ç’°å¢ƒ": {
      "main": [
        [
          {
            "node": "push çƒä¾†å°±æ‰“ (lab)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "push Dobby",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Triggers": {
      "main": [
        [
          {
            "node": "metadata (Push)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "çµ„èµ·ä¾† (Push)": {
      "main": [
        [
          {
            "node": "åˆ¤æ–· Push ç’°å¢ƒ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ä¸‹æ¬¡æ‰“çƒ v2 (Push)": {
      "main": [
        [
          {
            "node": "çµ„èµ·ä¾† (Push)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge (Push)": {
      "main": [
        [
          {
            "node": "ä¸‹æ¬¡æ‰“çƒ v2 (Push)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get People Next (Push)": {
      "main": [
        [
          {
            "node": "Merge (Push)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å–å¾—æ‰“çƒæ—¥ (Push)": {
      "main": [
        [
          {
            "node": "Merge (Push)",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "å–å¾—è©²å­£è³‡è¨Š (Push)": {
      "main": [
        [
          {
            "node": "Get People Next (Push)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "metadata (Push)": {
      "main": [
        [
          {
            "node": "å–å¾—æ‰“çƒæ—¥ (Push)",
            "type": "main",
            "index": 0
          },
          {
            "node": "å–å¾—è©²å­£è³‡è¨Š (Push)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Set Environment (Production)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge User Management": {
      "main": [
        [
          {
            "node": "Call 'Notion Badminton update user display_name'",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ›´æ–°ä½¿ç”¨è€…": {
      "main": [
        [
          {
            "node": "Merge User Management",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Update Data": {
      "main": [
        [
          {
            "node": "æ›´æ–°ä½¿ç”¨è€…",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "User Exists Switch": {
      "main": [
        [
          {
            "node": "Prepare Update Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "æ–°å¢ä½¿ç”¨è€…",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check User Exists": {
      "main": [
        [
          {
            "node": "User Exists Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check User Source": {
      "main": [
        [
          {
            "node": "å–å¾—ä½¿ç”¨è€…è¡¨",
            "type": "main",
            "index": 0
          },
          {
            "node": "Event Switch",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Event Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ–°å¢ä½¿ç”¨è€…": {
      "main": [
        [
          {
            "node": "Merge User Management",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "å–å¾—ä½¿ç”¨è€…è¡¨": {
      "main": [
        [
          {
            "node": "Check User Exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Join Source Filter": {
      "main": [
        [
          {
            "node": "å–å¾—æ­¡è¿è¨Šæ¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Event Switch": {
      "main": [
        [
          {
            "node": "is command",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Join Source Filter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ­¡è¿è¨Šæ¯ child blocks": {
      "main": [
        [
          {
            "node": "Welcome Message Parser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å–å¾—æ­¡è¿è¨Šæ¯": {
      "main": [
        [
          {
            "node": "æ­¡è¿è¨Šæ¯ child blocks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registration Final Reply": {
      "main": [
        [
          {
            "node": "çµ„èµ·ä¾†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Skip Auto Reply If Admin": {
      "main": [
        [],
        [
          {
            "node": "å–å¾— auto reply message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Admin Into Event": {
      "main": [
        [
          {
            "node": "if this user is manager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Welcome Message Parser": {
      "main": [
        [
          {
            "node": "çµ„èµ·ä¾†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åˆ¤æ–· webhook url": {
      "main": [
        [
          {
            "node": "reply çƒä¾†å°±æ‰“ (lab)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "reply Dobby",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Auto Reply Message": {
      "main": [
        [
          {
            "node": "çµ„èµ·ä¾†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å–å¾— auto reply message": {
      "main": [
        [
          {
            "node": "Auto Reply Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Payment Message": {
      "main": [
        [
          {
            "node": "çµ„èµ·ä¾†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ä»˜æ¬¾è³‡è¨Š child blocks": {
      "main": [
        [
          {
            "node": "Payment Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å–å¾—ä»˜æ¬¾è³‡è¨Š": {
      "main": [
        [
          {
            "node": "ä»˜æ¬¾è³‡è¨Š child blocks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Calendar for Announce": {
      "main": [
        [
          {
            "node": "End Branch Calendar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Season Info for Announce": {
      "main": [
        [
          {
            "node": "Get Calendar for Announce",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Announce Metadata": {
      "main": [
        [
          {
            "node": "Get People for Announce",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Season Info for Announce",
            "type": "main",
            "index": 0
          },
          {
            "node": "å–å¾—æœ€æ–°å…¬å‘Š",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Latest Announcement Message": {
      "main": [
        [
          {
            "node": "çµ„èµ·ä¾†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å–å¾—æœ€æ–°å…¬å‘Š": {
      "main": [
        [
          {
            "node": "æœ€æ–°å…¬å‘Š child blocks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "ä¸‹æ¬¡æ‰“çƒ v2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Flow Router (People)": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Sync Notion Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Flow Router (Next)": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "Sync Notion Data",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Get People Next": {
      "main": [
        [
          {
            "node": "Flow Router (People)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Match Participants": {
      "main": [
        [
          {
            "node": "çµ„èµ·ä¾†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get All People Global": {
      "main": [
        [
          {
            "node": "Match Participants",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Season Info Custom": {
      "main": [
        [
          {
            "node": "Get All People Global",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Season Metadata": {
      "main": [
        [
          {
            "node": "Get Season Info Custom",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ä¸‹æ¬¡æ‰“çƒ v2": {
      "main": [
        [
          {
            "node": "çµ„èµ·ä¾†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å–å¾—æ‰“çƒæ—¥": {
      "main": [
        [
          {
            "node": "Flow Router (Next)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æŒ‡ä»¤åˆ—è¡¨ message1": {
      "main": [
        [
          {
            "node": "çµ„èµ·ä¾†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Command controller": {
      "main": [
        [
          {
            "node": "metadata1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "æŒ‡ä»¤åˆ—è¡¨ message1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Season Metadata",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Announce Metadata",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "å–å¾—ä»˜æ¬¾è³‡è¨Š",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Registration Parser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "is command": {
      "main": [
        [
          {
            "node": "å–å¾—ä½¿ç”¨è€…è¡¨ (lazy)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Check Admin Before Auto Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "metadata1": {
      "main": [
        [
          {
            "node": "æœªç¹³è²»åå–®",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manager rules": {
      "main": [
        [
          {
            "node": "metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "if this user is manager": {
      "main": [
        [
          {
            "node": "Command controller",
            "type": "main",
            "index": 0
          },
          {
            "node": "Manager rules",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Command controller",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "metadata": {
      "main": [
        [
          {
            "node": "å–å¾—æ‰“çƒæ—¥",
            "type": "main",
            "index": 0
          },
          {
            "node": "å–å¾—è©²å­£è³‡è¨Š",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å–å¾—è©²å­£è³‡è¨Š": {
      "main": [
        [
          {
            "node": "Get People Next",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "çµ„èµ·ä¾†": {
      "main": [
        [
          {
            "node": "åˆ¤æ–· webhook url",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out": {
      "main": [
        [
          {
            "node": "active",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Branches 2": {
      "main": [
        [
          {
            "node": "Latest Announcement Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æœ€æ–°å…¬å‘Š child blocks": {
      "main": [
        [
          {
            "node": "End Branch Blocks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Branches 1": {
      "main": [
        [
          {
            "node": "Merge Branches 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get People for Announce": {
      "main": [
        [
          {
            "node": "End Branch People",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "End Branch Blocks": {
      "main": [
        [
          {
            "node": "Merge Branches 2",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "End Branch People": {
      "main": [
        [
          {
            "node": "Merge Branches 1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "End Branch Calendar": {
      "main": [
        [
          {
            "node": "Merge Branches 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æœªç¹³è²» message": {
      "main": [
        [
          {
            "node": "çµ„èµ·ä¾†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æœªç¹³è²»åå–®": {
      "main": [
        [
          {
            "node": "æœªç¹³è²» message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "active": {
      "main": [
        [
          {
            "node": "Check User Source",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Split Out",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": true,
    "timeSavedMode": "fixed",
    "timezone": "Asia/Taipei",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "1cc7059f-4856-4159-bd1b-220a7acd8a6f",
  "meta": {
    "instanceId": "434c89e639dca69ee85d48434474c04f2299edb82bd25537f48b2f00ff1d4403"
  },
  "id": "z-kTyrtVcRCn1Qs2zypfX",
  "tags": [
    {
      "name": "notion",
      "id": "7Ke8MqCOSwz5NZgC",
      "updatedAt": "2026-01-18T05:24:00.232Z",
      "createdAt": "2026-01-18T05:24:00.232Z"
    },
    {
      "updatedAt": "2025-04-15T05:32:41.173Z",
      "createdAt": "2025-04-15T05:32:41.173Z",
      "id": "aNPgZxmGaxoKb7As",
      "name": "line"
    },
    {
      "updatedAt": "2025-04-15T04:50:25.893Z",
      "createdAt": "2025-04-15T04:50:25.893Z",
      "id": "0i74kYvNo5LJ26IU",
      "name": "bot"
    }
  ]
}