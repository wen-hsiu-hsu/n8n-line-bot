{
  "name": "LineBot-Dobby-scheduled-message",
  "nodes": [
    {
      "parameters": {},
      "id": "29debcb9-1316-492a-b7bc-d1d97ca80c75",
      "name": "Manual Trigger (Push Test)",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        224,
        112
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "prod-env-marker",
              "name": "environment",
              "value": "production",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "49f57d0b-2d51-44c8-9c6f-f21afe68b1a1",
      "name": "Set Environment (Production)",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        448,
        -80
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "test-env-marker",
              "name": "environment",
              "value": "test",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "6cf19715-1eda-4c8c-93bc-35559772fe52",
      "name": "Set Environment (Test)",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        448,
        112
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.line.me/v2/bot/message/push",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { \"to\": \"C9fb61df21d9118e77d6e3065716fc08a\", \"messages\": $json.messages } }}",
        "options": {}
      },
      "id": "ca93e6b4-4f0f-40fc-af53-149aa0aaf766",
      "name": "push Dobby",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2464,
        112
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "AXXATrQhz9xpUGTR",
          "name": "Line Dobby"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.line.me/v2/bot/message/push",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { \"to\": \"U2a0a2c5054c4fa12b78a1d059411e39c\", \"messages\": $json.messages } }}",
        "options": {}
      },
      "id": "04007540-6696-462d-9c7f-3e220e8baafe",
      "name": "push çƒä¾†å°±æ‰“ (lab)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2464,
        -80
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "EeeK58MFzM1kWVEe",
          "name": "Line çƒä¾†å°±æ‰“"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "push-env-check",
              "leftValue": "={{ $json.environment }}",
              "rightValue": "test",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "cdc6fbec-6f0d-498b-92f9-bb982a6db301",
      "name": "åˆ¤æ–· Push ç’°å¢ƒ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        2240,
        16
      ]
    },
    {
      "parameters": {},
      "id": "5356f3ce-39b7-4562-90b0-587aabc660d7",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        672,
        16
      ]
    },
    {
      "parameters": {
        "jsCode": "const messages = $input.all().map(item => item.json)\n\n// å¾ metadata (Push) ç²å– environment\nconst metadataNode = $(\"metadata (Push)\").first();\nconst environment = metadataNode?.json?.environment || \"production\";\n\nreturn {\n  messages,\n  environment\n}"
      },
      "id": "018d10ff-29b8-4640-8732-2bde4da1303f",
      "name": "çµ„èµ·ä¾† (Push)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2016,
        16
      ]
    },
    {
      "parameters": {
        "jsCode": "const quarterInfo = $('å–å¾—è©²å­£è³‡è¨Š (Push)').first().json;\nconst metadata = $('metadata (Push)').first().json;\n\n// Robust property getters\nconst getNumber = (item, key) => (item.properties?.[key]?.number || item[`property_${key.toLowerCase()}`] || 0);\nconst getFormulaNumber = (item, key) => (item.properties?.[key]?.formula?.number || item[`property_${key.toLowerCase()}`] || 0);\nconst getName = (item) => (item.properties?.['Name']?.title?.[0]?.plain_text || item.property_name || item.name);\nconst getDate = (item) => (item.properties?.['æ™‚é–“']?.date?.start || (typeof item.property_æ™‚é–“ === 'string' ? item.property_æ™‚é–“ : item.property_æ™‚é–“?.start));\n\n// å¾ä¸åŒä¾†æºå½™æ•´è³‡è¨Š\nconst quarterData = {\n  fee: getNumber(quarterInfo, 'é›¶æ‰“è²»ç”¨') || metadata.price,\n  memberCount: getFormulaNumber(quarterInfo, 'å ±åäººæ•¸') || 0,\n  defaultCourts: metadata.courts // Fallback to metadata if not in Quarter DB\n};\n\n// å–å¾—ç•¶å‰ç¯€é» (Event) çš„è³‡æ–™\nconst targetDate = metadata.nextSaturdayDateText;\nconst allEvents = $('å–å¾—æ‰“çƒæ—¥ (Push)').all().map(item => item.json);\n\nconst eventPage = allEvents.find(page => {\n  const startTime = getDate(page);\n  return startTime && startTime.startsWith(targetDate);\n});\n\nif (!eventPage) {\n  return [\n    {\n      \"type\": \"text\",\n      \"text\": `âš ï¸ æ‰¾ä¸åˆ° ${targetDate} çš„æ‰“çƒæ—¥æ´»å‹•ã€‚\\nè«‹ç¢ºèª Notion è¡Œäº‹æ›†æ˜¯å¦å·²å»ºç«‹è©²æ—¥æœŸçš„é é¢ã€‚`\n    }\n  ];\n}\n\n// Get People Map\nconst peopleData = $('Get People Next (Push)').all().map(item => item.json);\nconst peopleMap = new Map();\npeopleData.forEach(p => peopleMap.set(p.id, p));\n\nconst eventData = {\n  type: eventPage.properties?.['é¡å‹']?.select?.name || eventPage.property_é¡å‹,\n  timeStart: getDate(eventPage),\n  courtOverride: getNumber(eventPage, 'å ´åœ°æ•¸'),\n  absenteesRelations: eventPage.properties?.['è«‹å‡äºº']?.relation || eventPage.property_è«‹å‡äºº || [],\n  absenteesCount: (eventPage.properties?.['è«‹å‡äºº']?.relation?.length ?? eventPage.property_è«‹å‡äºº?.length ?? 0)\n};\n\n// 1. æª¢æŸ¥æ˜¯å¦æš«åœ\nif (eventData.type && eventData.type.includes('æš«åœ')) {\n  return [\n    {\n      \"type\": \"text\",\n      \"text\": `ğŸ“… ${targetDate}\\n\\nğŸ›‘ æœ¬é€±æ‰“çƒæš«åœ (Suspended)\\nä¼‘æ¯æ˜¯ç‚ºäº†èµ°æ›´é•·é çš„è·¯ï¼`\n    }\n  ];\n}\n\n// 2. è¨ˆç®—é‚è¼¯\n// å ´åœ°æ•¸ï¼šå„ªå…ˆä½¿ç”¨ Event Overrideï¼Œå¦å‰‡ä½¿ç”¨ Quarter Default (or Metadata default)\nconst finalCourts = eventData.courtOverride || quarterData.defaultCourts;\nconst courtsDensity = 7; // æ¯é¢å ´åœ° 7 äºº\n\n// ç¸½è«‹å‡äººæ•¸ï¼šEvent ç´€éŒ„çš„è«‹å‡äºº + æŒ‡ä»¤åƒæ•¸é¡å¤–æ‰£é™¤çš„ (metadata.offCounts)\nconst manualOffCounts = Number(metadata.offCounts) || 0;\nconst totalAbsentees = eventData.absenteesCount + manualOffCounts;\n\n// Resolve Names\nconst absenteeNames = eventData.absenteesRelations.map(r => {\n    const id = r.id || r;\n    const person = peopleMap.get(id);\n    return getName(person || {});\n}).filter(n => n);\n\nconst leaveString = absenteeNames.length > 0 ? `è«‹å‡ï¼š${absenteeNames.join(', ')}` : `è«‹å‡ï¼šç„¡`;\n\n// æ‡‰åˆ°äººæ•¸ (å­£ç§Ÿ - è«‹å‡)\nconst expectedMembers = quarterData.memberCount - totalAbsentees;\n\n// é›¶æ‰“åé¡\nconst totalSlots = finalCourts * courtsDensity;\nconst availableSlots = Math.max(0, totalSlots - expectedMembers);\n\n// 3. æ ¼å¼åŒ–è¼¸å‡º\nconst dateStr = eventData.timeStart ? eventData.timeStart.split('T')[0] : targetDate;\n\nfunction generateNumberedListString(number) {\n  if (number <= 0) return '(ç„¡åé¡)';\n  const lines = [];\n  for (let i = 1; i <= number; i++) {\n    lines.push(`${i}.`);\n  }\n  return lines.join('\\n');\n}\n\nreturn [\n  {\n    \"type\":\"text\",\n    \"text\":[\n      `${dateStr} ä¸èƒ½åˆ°è«‹å–Šè²`,\n      leaveString,\n      `å ´åœ°ï¼š${finalCourts} é¢`,\n      `æ‡‰åˆ°ï¼š${expectedMembers} äºº`,\n      `é›¶æ‰“åé¡ï¼š${availableSlots}äºº $${quarterData.fee}/äºº`\n    ].join('\\n')\n  },\n  {\n    \"type\":\"text\",\n    \"text\":[\n      `${dateStr}`,\n      `é›¶æ‰“åé¡ ${availableSlots} äºº | $${quarterData.fee}/äºº`, \n      `${generateNumberedListString(availableSlots)}`\n    ].join('\\n')\n  }\n];"
      },
      "id": "083e0ca3-669e-43ef-b4eb-8662a170efc6",
      "name": "ä¸‹æ¬¡æ‰“çƒ v2 (Push)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1792,
        16
      ]
    },
    {
      "parameters": {},
      "id": "f8471a06-0638-43a7-92bb-c463f053e123",
      "name": "Merge (Push)",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [
        1568,
        16
      ]
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "252f388d-4ac7-49a4-82ae-a7f18044f701",
          "mode": "list",
          "cachedResultName": "äººå“¡æ¸…å–®",
          "cachedResultUrl": "https://www.notion.so/252f388d4ac749a482aea7f18044f701"
        },
        "returnAll": true,
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "å ±åå­£åº¦|relation",
              "condition": "contains",
              "relationValue": "={{ $json.id }}"
            }
          ]
        },
        "options": {}
      },
      "id": "35a2eaf6-f340-4110-af7f-d214739df452",
      "name": "Get People Next (Push)",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        1344,
        -80
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "0fd76b77-9f07-4aa3-a3c9-12ba18dbe32e",
          "mode": "list",
          "cachedResultName": "è¡Œäº‹æ›†",
          "cachedResultUrl": "https://www.notion.so/0fd76b779f074aa3a3c912ba18dbe32e"
        },
        "simple": false,
        "filterType": "json",
        "filterJson": "={{ JSON.stringify({ and: [{ property: 'æ™‚é–“', date: { equals: $json.nextSaturdayDateText } }] }) }}",
        "options": {}
      },
      "id": "4a601ff9-74f1-4429-8400-510b5fd37ba7",
      "name": "å–å¾—æ‰“çƒæ—¥ (Push)",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        1344,
        112
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "resource": "databasePage",
        "operation": "getAll",
        "databaseId": {
          "__rl": true,
          "value": "7deede34-579d-4c77-b79b-20b9f4f000e7",
          "mode": "list",
          "cachedResultName": "å­£ç§Ÿæ‰¿ç§Ÿç´€éŒ„",
          "cachedResultUrl": "https://www.notion.so/7deede34579d4c77b79b20b9f4f000e7"
        },
        "simple": false,
        "filterType": "manual",
        "filters": {
          "conditions": [
            {
              "key": "å­£ç§Ÿæ™‚æ®µ|title",
              "condition": "equals",
              "titleValue": "={{ $json.nextSaturdayQuarter }}"
            }
          ]
        },
        "options": {}
      },
      "id": "abd8dff2-cedf-4629-b225-a5a90ec4f28a",
      "name": "å–å¾—è©²å­£è³‡è¨Š (Push)",
      "type": "n8n-nodes-base.notion",
      "typeVersion": 2.2,
      "position": [
        1120,
        -80
      ],
      "credentials": {
        "notionApi": {
          "id": "RRcVukfrFBXC9j01",
          "name": "Notion account (ä¿® s1027401)"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "function getNextSaturday () {\n  const now = DateTime.now(); \n  const currentWeekday = now.weekday; \n  const daysUntilSaturday = (6 - currentWeekday + 7) % 7; \n  const nextSaturday = now.plus({ days: daysUntilSaturday });\n  return nextSaturday\n}\n\nfunction getNextSaturdayQuarter() {\n  const nextSaturday = getNextSaturday()\n  const year = nextSaturday.year;\n  const quarter = nextSaturday.quarter;\n  return `${year}-Q${quarter}`;\n}\n\nfunction getNextSaturdayDateText () {\n  const nextSaturday = getNextSaturday()\n  return nextSaturday.toFormat('yyyy-MM-dd')\n}\n\nconst DEFAULT_OFF_COUNTS = 0\nconst DEFAULT_COURT = 2\nconst DEFAULT_PRICE = 170\n\n// å¾ä¸Šæ¸¸ç²å– environment\nconst environment = $json.environment || \"production\";\n\nreturn {\n  nextSaturdayQuarter: getNextSaturdayQuarter(),\n  nextSaturdayDateText: getNextSaturdayDateText(),\n  offCounts: DEFAULT_OFF_COUNTS,\n  courts: DEFAULT_COURT,\n  price: DEFAULT_PRICE,\n  environment: environment\n}"
      },
      "id": "80449791-bdbf-46b3-9c62-238266f9cd91",
      "name": "metadata (Push)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        896,
        16
      ]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "weeks",
              "triggerAtHour": 9
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        224,
        -80
      ],
      "id": "668d566d-92d3-4bd7-a9fa-dd120c997860",
      "name": "Schedule Trigger"
    }
  ],
  "pinData": {},
  "connections": {
    "Manual Trigger (Push Test)": {
      "main": [
        [
          {
            "node": "Set Environment (Test)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Environment (Production)": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Environment (Test)": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åˆ¤æ–· Push ç’°å¢ƒ": {
      "main": [
        [
          {
            "node": "push çƒä¾†å°±æ‰“ (lab)",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Merge Triggers": {
      "main": [
        [
          {
            "node": "metadata (Push)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "çµ„èµ·ä¾† (Push)": {
      "main": [
        [
          {
            "node": "åˆ¤æ–· Push ç’°å¢ƒ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ä¸‹æ¬¡æ‰“çƒ v2 (Push)": {
      "main": [
        [
          {
            "node": "çµ„èµ·ä¾† (Push)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge (Push)": {
      "main": [
        [
          {
            "node": "ä¸‹æ¬¡æ‰“çƒ v2 (Push)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get People Next (Push)": {
      "main": [
        [
          {
            "node": "Merge (Push)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å–å¾—æ‰“çƒæ—¥ (Push)": {
      "main": [
        [
          {
            "node": "Merge (Push)",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "å–å¾—è©²å­£è³‡è¨Š (Push)": {
      "main": [
        [
          {
            "node": "Get People Next (Push)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "metadata (Push)": {
      "main": [
        [
          {
            "node": "å–å¾—æ‰“çƒæ—¥ (Push)",
            "type": "main",
            "index": 0
          },
          {
            "node": "å–å¾—è©²å­£è³‡è¨Š (Push)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Set Environment (Production)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "050c4123-d6fa-4d07-867e-199362f54cb1",
  "meta": {
    "instanceId": "434c89e639dca69ee85d48434474c04f2299edb82bd25537f48b2f00ff1d4403"
  },
  "id": "MToJHnVEMzGAJYrvLHioU",
  "tags": [
    {
      "updatedAt": "2025-04-15T04:50:25.893Z",
      "createdAt": "2025-04-15T04:50:25.893Z",
      "id": "0i74kYvNo5LJ26IU",
      "name": "bot"
    },
    {
      "updatedAt": "2026-01-18T05:24:00.232Z",
      "createdAt": "2026-01-18T05:24:00.232Z",
      "id": "7Ke8MqCOSwz5NZgC",
      "name": "notion"
    },
    {
      "updatedAt": "2025-04-15T05:32:41.173Z",
      "createdAt": "2025-04-15T05:32:41.173Z",
      "id": "aNPgZxmGaxoKb7As",
      "name": "line"
    },
    {
      "updatedAt": "2026-01-18T05:24:07.460Z",
      "createdAt": "2026-01-18T05:24:07.460Z",
      "id": "bJJAP51qCdrdLEwN",
      "name": "line bot"
    }
  ]
}